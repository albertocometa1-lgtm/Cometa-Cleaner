<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Pulizie di Casa</title>
<link rel="manifest" href="/manifest.json?v=1">
<link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Sappylo">
<meta name="theme-color" content="#A0C4FF">
<style>
:root{
  --accent-color:#A0C4FF; --accent-color-2:#B9FBC0;
  --bg-light:#F8F5FF;
  --bg-color:var(--bg-light);
  --surface-color:#FFFFFF; --text-color:#2D2D2D; --muted-color:#6B7280; --border-color:#E5E7EB;
  --btn-bg-color:var(--surface-color); --btn-text-color:var(--text-color);
  --placeholder-color:rgba(45,45,45,.6);
  --toast-bg-color:#1f2937; --toast-text-color:#fff; --danger-color:#FFB3C1;
  --shadow:0 1px 3px rgba(0,0,0,.08);
  --radius:12px; --fs-1:18px; --fs-2:16px; --fs-3:14px;
  --c-future:#FFFFFF; --c-future-text:#2D2D2D;
  --c-due:#FFF3B0; --c-due-text:#2D2D2D;
  --c-over:#FFB3C1; --c-over-text:#2D2D2D;
  --c-done:#B9FBC0; --c-done-text:#2D2D2D;
  --delta-pos:#117733; --delta-neg:#B00020;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-left: env(safe-area-inset-left, 0px);
  --safe-right: env(safe-area-inset-right, 0px);
  --icon-on-bg: var(--text-color);
  --icon-on-surface: var(--text-color);
  --btn-icon-color: var(--icon-on-surface);
  --nav-bg: var(--surface-color);
  --nav-fg: var(--text-color);
  --nav-fg-active: var(--accent-color);
  --nav-indicator: var(--accent-color);
  --nav-height: 56px;
}
@media (prefers-color-scheme: dark){
  :root{
    --bg-color:#1E1E1E; --surface-color:#2B2B2B; --text-color:#F9FAFB; --muted-color:#9CA3AF; --border-color:#3F3F46; --shadow:0 1px 3px rgba(0,0,0,.5);
    --toast-bg-color:#111827; --toast-text-color:#fff; --danger-color:#7F1D1D;
    --c-future:#2B2B2B; --c-future-text:#F9FAFB; --c-due:#665C00; --c-due-text:#F9FAFB; --c-over:#7F1D1D; --c-over-text:#F9FAFB; --c-done:#065F46; --c-done-text:#F9FAFB;
  }
}
html[data-theme="light"]{
  --bg-color:var(--bg-light); --surface-color:#FFFFFF; --text-color:#2D2D2D; --muted-color:#6B7280; --border-color:#E5E7EB; --shadow:0 1px 3px rgba(0,0,0,.08);
  --toast-bg-color:#1f2937; --toast-text-color:#fff; --danger-color:#FFB3C1;
  --c-future:#FFFFFF; --c-future-text:#2D2D2D; --c-due:#FFF3B0; --c-due-text:#2D2D2D; --c-over:#FFB3C1; --c-over-text:#2D2D2D; --c-done:#B9FBC0; --c-done-text:#2D2D2D;
}
html[data-theme="dark"]{
  --bg-color:#1E1E1E; --surface-color:#2B2B2B; --text-color:#F9FAFB; --muted-color:#9CA3AF; --border-color:#3F3F46; --shadow:0 1px 3px rgba(0,0,0,.5);
  --toast-bg-color:#111827; --toast-text-color:#fff; --danger-color:#7F1D1D;
  --c-future:#2B2B2B; --c-future-text:#F9FAFB; --c-due:#665C00; --c-due-text:#F9FAFB; --c-over:#7F1D1D; --c-over-text:#F9FAFB; --c-done:#065F46; --c-done-text:#F9FAFB;
}
@media (display-mode: standalone){
  :root{ --safe-top:0px; --safe-bottom:0px; }
}
*{box-sizing:border-box}
img{max-width:100%;height:auto;}
html,body{
  height:100%;
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial;
  min-height:100svh;
  min-height:100dvh; /* evita tagli su mobile con barra URL dinamica */
  overflow:hidden;
  overscroll-behavior:none;
}
html{
  scroll-padding-top:var(--nav-height);
  scroll-padding-bottom:var(--safe-bottom);
}
body{
  background:var(--bg-color);
  color:var(--text-color);
  line-height:1.45;
}
.app-shell{
  --p-top:max(var(--safe-top),8px);
  min-height:100dvh;
  height:var(--vh,100dvh);
  padding:var(--p-top) max(var(--safe-right),8px) max(var(--safe-bottom),8px) max(var(--safe-left),8px);
  display:flex;
  flex-direction:column;
}
.scroll-area{
  overflow:auto;
  overscroll-behavior:contain;
  -webkit-overflow-scrolling:touch;
}
header{
  position:sticky; top:0; z-index:30;
  margin-top:calc(-1 * var(--p-top));
  background:var(--nav-bg);
  box-shadow:var(--shadow);
}
header .top-bar{
  display:flex; align-items:center; gap:10px;
  padding:calc(10px + var(--safe-top)) 12px 10px;
}
header h1{font-size:var(--fs-1); margin:0; flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
.logo{width:26px;height:26px;border-radius:6px;object-fit:cover;border:1px solid var(--border-color); background:var(--accent-color);}
.user-pill{display:flex; align-items:center; gap:8px; border:1px solid var(--border-color); padding:6px 10px; border-radius:999px; background:var(--accent-color-2);}
.avatar{width:20px; height:20px; border-radius:50%; object-fit:cover; background:var(--accent-color-2);}
.nav-tabs{position:relative; display:flex; overflow-x:auto; scroll-snap-type:x mandatory; background:var(--nav-bg); color:var(--nav-fg);}
.nav-tabs::-webkit-scrollbar{display:none;}
.nav-tabs::before,.nav-tabs::after{content:""; position:absolute; top:0; bottom:0; width:12px; pointer-events:none;}
.nav-tabs::before{left:0; background:linear-gradient(to right,var(--nav-bg),transparent);}
.nav-tabs::after{right:0; background:linear-gradient(to left,var(--nav-bg),transparent);}
.nav-tab{position:relative; flex:0 0 auto; display:flex; align-items:center; gap:8px; padding:0 16px; min-height:56px; font-size:16px; font-weight:500; line-height:1.3; background:none; border:none; color:inherit; cursor:pointer; scroll-snap-align:start;}
.nav-tab .icon{width:20px; height:20px; flex:0 0 20px;}
.nav-tab:focus-visible{outline:2px solid var(--nav-indicator); outline-offset:2px;}
.nav-tab:active{background:var(--accent-color-2);}
.nav-tab.active{color:var(--nav-fg-active);}
.nav-tab.active::after{content:""; position:absolute; left:12px; right:12px; bottom:0; height:2px; background:var(--nav-indicator); border-radius:2px;}
@media(max-width:359px){.nav-tab{padding:0 10px; font-size:14px;}}
@media(min-width:600px){.nav-tab{flex:1; justify-content:center;}}
.container{max-width:860px; margin:0 auto; padding:12px; display:flex; flex-direction:column; min-height:calc(100svh - var(--nav-height)); min-height:calc(100dvh - var(--nav-height));}
.view{display:none; flex-direction:column; flex:1;}
.view.active{display:flex;}
#viewTasks{min-height:0;}
ul#list{list-style:none; padding:0; margin:0; flex:1;}
ul#list:empty{display:none;}
#empty{flex:1; display:flex; align-items:center; justify-content:center;}

/* Tabs (Da Fare) */
.tabs{display:flex; gap:8px; margin:6px 0 10px}
.tab{flex:0 0 auto; padding:8px 12px; border-radius:999px; border:1px solid var(--border-color); background:var(--surface-color); font-weight:700; cursor:pointer}
.tab.active{ --btn-bg-color:var(--accent-color); background:var(--btn-bg-color); color:var(--btn-text-color); border-color:var(--accent-color);}

/* Lista pulizie */
li.task{ margin:10px 0; border-radius:12px; border:1px solid var(--border-color); box-shadow:var(--shadow); overflow:hidden; cursor:pointer; }
.task-head{ display:flex; align-items:center; gap:10px; padding:12px 14px; }
.chk input{ width:26px; height:26px; }
.head-main{ flex:1; min-width:0; }
.title{ font-weight:800; font-size:var(--fs-2); word-break:break-word; }
.notes-line{ font-size:var(--fs-3); opacity:.9; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:2px;}
.date-badge{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(0,0,0,.08); background:rgba(255,255,255,.35)}
.chev{ transition:transform .2s } li.task.expanded .chev{ transform:rotate(90deg); }
.task-details{ display:none; padding:10px 14px 14px; border-top:1px dashed rgba(0,0,0,.12); }
li.task.expanded .task-details{ display:block; }

/* Stato colori */
li.task.future { background:var(--c-future); color:var(--c-future-text); }
li.task.due { background:var(--c-due); color:var(--c-due-text); }
li.task.over { background:var(--c-over); color:var(--c-over-text); }
li.task.done { background:var(--c-done); color:var(--c-done-text); }
li.task.future .date-badge{border-color:rgba(0,0,0,.08)}
li.task.due .date-badge, li.task.over .date-badge, li.task.done .date-badge{ border-color:rgba(255,255,255,.35)}
.badges{ display:flex; flex-wrap:wrap; gap:6px; margin-top:6px}
.badges span{ font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid rgba(0,0,0,.15); background:rgba(255,255,255,.25); }
.assignee-me{ background:rgba(37,99,235,.2)!important; } .assignee-partner{ background:rgba(225,29,72,.2)!important; }
.actions{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap }
.btn{ padding:10px 12px; border:1px solid var(--border-color); border-radius:8px; background:var(--btn-bg-color); color:var(--btn-text-color); cursor:pointer; min-height:44px; }
.btn:focus-visible{ outline:2px solid var(--accent-color); outline-offset:2px; }
.btn.primary{ --btn-bg-color:var(--accent-color); border-color:var(--accent-color) }
.btn.secondary{ --btn-bg-color:var(--accent-color-2); border-color:var(--accent-color-2) }
.btn-danger{ --btn-bg-color:var(--danger-color); border-color:var(--danger-color) }
.btn.icon{ padding:6px; min-height:32px; display:flex; align-items:center; justify-content:center; }
.icon-btn{ background:none; border:none; padding:6px; display:flex; align-items:center; justify-content:center; color:var(--btn-icon-color); cursor:pointer; min-width:44px; min-height:44px; }
.icon-btn:hover{ background:var(--accent-color-2); border-radius:6px; }
.icon-btn:active{ background:var(--accent-color); color:var(--icon-on-bg); }
.icon-btn:focus-visible{ outline:2px solid var(--accent-color); outline-offset:2px; }
.loader{ position:fixed; inset:0; z-index:100; background:var(--bg-color); display:none; align-items:center; justify-content:center; padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); }
.loader.is-active{ display:flex; }
.loader-logo{ width:72px; height:72px; animation:spin 1.2s linear infinite; }
@keyframes spin{ from{transform:rotate(0deg);} to{transform:rotate(360deg);} }
.sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
.empty{ padding:24px; text-align:center; color:var(--text-color); opacity:.9; font-size:var(--fs-2) }

/* Forms */
.grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
.grid .full{ grid-column:1/-1 }
.add-row{ margin-top:10px; padding-top:10px; border-top:1px solid var(--border-color); }
input, select, textarea{ padding:12px; border:1px solid var(--border-color); border-radius:8px; background:var(--surface-color); color:var(--text-color); font-size:var(--fs-2) }
textarea{ min-height:80px; resize:vertical }
input::placeholder, textarea::placeholder{ color:var(--placeholder-color); }
.toggle{
  appearance:none;
  width:44px;
  height:24px;
  background:var(--border-color);
  border-radius:12px;
  position:relative;
  cursor:pointer;
  border:none;
}
.toggle:focus-visible{outline:2px solid var(--accent-color); outline-offset:2px;}
.toggle::before{
  content:"";
  position:absolute;
  top:2px; left:2px;
  width:20px; height:20px;
  background:var(--surface-color);
  border-radius:50%;
  transition:transform .2s;
}
.toggle:checked{ background:var(--accent-color); }
.toggle:checked::before{ transform:translateX(20px); }
.weekdays{ display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
.weekdays label{ display:flex; align-items:center; gap:4px; }
.photo-zone{ border:2px dashed var(--border-color); border-radius:12px; padding:20px; text-align:center; cursor:pointer; }
.photo-zone.hover{ background:var(--bg-color); }
.photo-preview{ position:relative; margin-top:10px; display:none; }
.photo-preview img{ width:100px; height:100px; object-fit:cover; border-radius:12px; border:1px solid var(--border-color); }
.photo-preview button{ position:absolute; top:4px; right:4px; }

.filter-box{background:var(--surface-color);border:1px solid var(--border-color);border-radius:16px;padding:16px;}
.filter-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.filter-grid .full{grid-column:1/-1;}
.filter-box label{font-weight:600;font-size:var(--fs-2);display:flex;flex-direction:column;gap:4px;}
.filter-box label.check{flex-direction:row;align-items:center;min-height:44px;padding:4px 8px;border:1px solid var(--border-color);border-radius:12px;}
 .filter-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:16px;}
 @media(max-width:480px){.filter-grid{grid-template-columns:1fr;}}

/* Drawer modale (bottom sheet per filtri, editor, calendario) */
.drawer{ position:fixed; inset:0; z-index:150; display:none; }
.drawer.open{ display:block; }
.drawer .scrim{ position:absolute; inset:0; background:rgba(0,0,0,.35); }
.drawer .panel{
  position:absolute; left:0; right:0; bottom:0;
  max-height:90svh; max-height:90dvh;
  background:var(--surface-color);
  border-top:1px solid var(--border-color);
  box-shadow:0 -4px 16px rgba(0,0,0,.1);
  transform:translateY(100%);
  transition:transform .18s ease;
  padding:14px;
  border-radius:16px 16px 0 0;
  padding-bottom:calc(16px + var(--safe-bottom));
}
.drawer.open .panel{ transform:none; }
.drawer .panel header{ position:sticky; top:0; background:var(--surface-color); padding:calc(12px + var(--safe-top)) 16px 12px; display:flex; align-items:center; gap:10px; border-bottom:1px solid var(--border-color); }
.drawer .panel .content{ padding:12px 16px calc(16px + var(--safe-bottom)); }

/* Task full-screen view */
.task-view{
  position:fixed;
  inset:0;
  z-index:6000;
  background:var(--surface-color);
  display:none;
  flex-direction:column;
}
.task-view header{
  display:flex;
  align-items:center;
  gap:10px;
  padding:calc(12px + var(--safe-top)) 16px 12px;
  border-bottom:1px solid var(--border-color);
}
.task-view .content{
  flex:1;
  padding:16px 16px calc(16px + var(--safe-bottom));
}
.task-view .photos{
  display:flex;
  flex-direction:column;
  gap:10px;
  margin-top:10px;
}
.task-view .photos img{
  width:100%;
  border-radius:12px;
  border:1px solid var(--border-color);
  object-fit:cover;
}

/* Classifica */
.leader{ display:grid; gap:10px; }
.row{ display:flex; align-items:center; gap:10px; background:var(--surface-color); border:1px solid var(--border-color); padding:10px; border-radius:12px; box-shadow:var(--shadow); flex-wrap:wrap; overflow:hidden }
.row .pts{ margin-left:auto; font-weight:800 }
.history{ margin-top:12px; }
.event{ display:flex; gap:10px; align-items:center; border:1px dashed var(--border-color); background:var(--surface-color); padding:8px 10px; border-radius:12px; margin:6px 0; }
.delta{ font-weight:800; }
.delta.pos{ color:var(--delta-pos) } .delta.neg{ color:var(--delta-neg) }

/* Dati & Backup mobile */
.grid-compact{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }
.grid-compact > .btn,
.grid-compact > .file-btn{
  width:100%;
  aspect-ratio:1/1;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  overflow:hidden;
}
.btn.block{ width:100%; }
.file-btn{
  display:inline-flex; align-items:center; justify-content:center; gap:8px;
  padding:12px; border:1px solid var(--border-color); border-radius:8px;
  background:var(--accent-color-2); cursor:pointer; text-align:center; font-weight:600;
  color:var(--text-color);
}
.file-btn input[type="file"]{ display:none; }
.small-note{ font-size:12px; opacity:.7; margin-top:8px; }

/* Toast */
.toast-wrap{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:var(--safe-bottom);
  z-index:200; display:flex; flex-direction:column; gap:8px; align-items:center;
}
.toast{ background:var(--toast-bg-color); color:var(--toast-text-color); padding:10px 14px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.25); font-weight:600; max-width:90vw; }

/* Drawer filtri (alto-destra, mobile-friendly) */
.drawer{ position:fixed; inset:0; z-index:150; display:none; }
.drawer.open{ display:block; }
.drawer .scrim{ position:absolute; inset:0; background:rgba(0,0,0,.35); }
.drawer .panel{
  position:absolute; right:0; top:0; bottom:auto;
  width:min(420px, 92vw);
  max-height:86svh; max-height:86dvh;
  background:var(--surface-color);
  border-left:1px solid var(--border-color);
  box-shadow:var(--shadow);
  transform:translateY(-100%);
  transition:transform .24s ease;
  padding:14px;
  margin-top:calc(8px + var(--safe-top));
  border-radius:0 0 0 16px;
}
.drawer.open .panel{ transform:none; }
@media (max-width:560px){
  .drawer .panel{
    left:0; right:0; width:100%; border-left:none; border-radius:0 0 16px 16px;
  }
}

/* Calendario */
.cal-toolbar{ display:flex; align-items:center; gap:8px; margin:8px 0 12px; }
.cal-title{ font-weight:800; font-size:var(--fs-1); flex:1; text-align:center; }
.cal-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }
.cal-dow{ text-align:center; font-weight:700; font-size:12px; opacity:.8; padding:6px 0; }
.cal-cell{
  background:var(--surface-color); border:1px solid var(--border-color); border-radius:10px; padding:8px; min-height:64px; position:relative;
  display:flex; flex-direction:column; gap:6px; box-shadow:var(--shadow);
}
.cal-daynum{
  font-weight:800; font-size:12px; opacity:.9;
  padding-right:24px; padding-top:2px; line-height:1;
}
.cal-badge{
  position:absolute; top:4px; right:4px; z-index:2;
  font-size:11px; min-width:20px; min-height:20px; padding:0 6px;
  display:flex; align-items:center; justify-content:center;
  border-radius:999px; border:1px solid var(--border-color);
  background:var(--accent-color-2); color:var(--text-on-accent2);
  pointer-events:none;
}
@media (max-width:359px){
  .cal-badge{ transform:scale(.85); font-size:10px; }
  .cal-daynum{ padding-right:20px; }
}
@media (min-width:360px) and (max-width:768px){
  .cal-badge{ font-size:11px; }
  .cal-daynum{ padding-right:24px; }
}
@media (min-width:769px){
  .cal-badge{ font-size:12px; padding:0 8px; }
  .cal-daynum{ padding-right:28px; }
}
.cal-cell.muted{ opacity:.55; }
.cal-cell.today{ border:2px solid var(--accent-color); }
.cal-cell.selected{ outline:2px solid var(--accent-color-2); }
.cal-empty{ padding:12px; text-align:center; opacity:.8; }

/* Accordion moderno (Impostazioni, un solo open alla volta) */
.accordion details{
  border:1px solid var(--border-color);
  border-radius:12px;
  margin:10px 0;
  background:var(--surface-color);
  box-shadow:var(--shadow);
  overflow:hidden;
}
.accordion summary{
  list-style:none;
  cursor:pointer;
  padding:12px 14px;
  font-weight:800;
  display:flex; align-items:center; gap:10px;
}
.accordion summary::-webkit-details-marker{ display:none; }
.accordion details[open] summary{
  background:var(--accent-color);
  color:var(--text-color);
  border-bottom:1px solid var(--border-color);
}
.accordion details > *:not(summary){ padding:12px 14px; }
</style>
</head>
<body>
<div class="app-shell scroll-area">
<header id="appHeader">
  <div class="top-bar">
    <img id="appLogo" class="logo" alt="Logo">
    <h1 id="appTitle">Pulizie di Casa</h1>
    <button id="toggleFilters" class="icon-btn" aria-label="Filtri">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M3 4h18l-7 8v6l-4 2v-8z"/></svg>
    </button>
    <button id="addTaskBtn" class="icon-btn" aria-label="Nuova pulizia">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M12 5v14M5 12h14"/></svg>
    </button>
    <span class="user-pill" id="userPill">
      <img id="avatar" class="avatar" alt="">
      <strong id="who">Utente</strong>
    </span>
  </div>
  <nav id="mainNav" class="nav-tabs" role="tablist">
    <button class="nav-tab active" data-tab="tasks" role="tab" aria-selected="true">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M4 4h16v16H4z"/><path d="M8 8h8M8 12h8M8 16h8"/></svg>
      <span>Pulizie</span>
    </button>
    <button class="nav-tab" data-tab="calendar" role="tab" aria-selected="false">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M3 4h18v18H3z"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
      <span>Calendario</span>
    </button>
    <button class="nav-tab" data-tab="rank" role="tab" aria-selected="false">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M7 21v-8M12 21V3M17 21v-5"/></svg>
      <span>Classifica</span>
    </button>
    <button class="nav-tab" data-tab="settings" role="tab" aria-selected="false">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .69.4 1.3 1.01 1.58.61.28 1.32.04 1.69-.53a2 2 0 1 1 3.46 2.07 1.65 1.65 0 0 0-.1 1.35c.17.67.24 1.37.2 2.05a2 2 0 1 1-3.46 2.07 1.65 1.65 0 0 0-.1-1.35A1.65 1.65 0 0 0 19.4 15z"/></svg>
      <span>Impostazioni</span>
    </button>
  </nav>
</header>

<main class="container">
  <!-- VIEW: DA FARE -->
  <section id="viewTasks" class="view active">
    <div class="tabs">
      <button class="tab active" data-scope="oggi">Oggi</button>
      <button class="tab" data-scope="tutte">Tutte</button>
    </div>
    <div class="chips" id="activeChips" style="margin:0 0 8px 0"></div>
    <ul id="list" class="scroll-area"></ul>
    <div class="empty" id="empty" style="display:none">Niente da mostrare 🧽</div>
  </section>

  <!-- VIEW: CALENDARIO -->
  <section id="viewCalendar" class="view">
    <div class="cal-toolbar">
      <button id="calPrev" class="btn" aria-label="Mese precedente">◀</button>
      <div id="calTitle" class="cal-title">Mese Anno</div>
      <button id="calNext" class="btn" aria-label="Mese successivo">▶</button>
    </div>
    <div style="display:flex; gap:8px; margin-bottom:8px;">
      <button id="calToday" class="btn">Oggi</button>
      <button id="calAdd" class="btn primary" style="margin-left:auto">Aggiungi pulizie</button>
    </div>
    <div id="calGrid" class="cal-grid" aria-label="Calendario mensile"></div>
  </section>

  <!-- VIEW: CLASSIFICA -->
  <section id="viewRank" class="view">
    <h2>Classifica</h2>
    <div id="leader" class="leader"></div>
    <details class="history" open>
      <summary>Storico punteggi</summary>
      <div id="historyList"></div>
    </details>
    <p class="muted">Regole: +10 in tempo, +5 in anticipo, +2 in ritardo, -5 malus/dì ignorato (overdue non completato).</p>
  </section>

  <!-- VIEW: IMPOSTAZIONI -->
  <section id="viewSettings" class="view">
    <h2>Impostazioni</h2>
    <div id="settingsAccordion" class="accordion">
      <details open>
        <summary>Utente attivo</summary>
        <div class="grid" style="margin-top:10px">
          <select id="activeUser"></select>
          <button id="swapToActive" class="btn">Imposta attivo</button>
        </div>
      </details>
      <details>
        <summary>Gestione utenti</summary>
        <div id="usersList" class="grid" style="margin-top:10px"></div>
        <div class="grid add-row">
          <input id="u-name" placeholder="Nome utente">
          <select id="u-color"></select>
          <label class="btn">Foto utente <input id="u-photo" type="file" accept="image/*" style="display:none"></label>
          <button id="u-add" class="btn primary">Aggiungi utente</button>
        </div>
      </details>
      <details>
        <summary>Stanze</summary>
        <div class="grid" id="roomsList" style="margin-top:10px"></div>
        <div class="grid add-row">
          <input id="r-name" placeholder="Nuova stanza">
          <label class="btn">Foto stanza <input id="r-photo" type="file" accept="image/*" style="display:none"></label>
          <button id="r-add" class="btn primary">Aggiungi stanza</button>
        </div>
      </details>
      <details>
        <summary>Aspetto</summary>
        <div class="grid" style="margin-top:10px">
          <div class="full">
            <strong>Palette app</strong>
            <div id="appPalettes" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px"></div>
          </div>
            <label class="field full">Tema
              <select id="themeSelect">
                <option value="system">Sistema</option>
                <option value="light">Chiaro</option>
                <option value="dark">Scuro</option>
              </select>
            </label>
        </div>
      </details>
      <details>
        <summary>Notifiche &amp; Promemoria</summary>
        <div class="grid" style="margin-top:10px">
          <label class="field full">Ora promemoria (HH:MM)
            <input id="remindAt" placeholder="09:00" value="09:00">
          </label>
          <label><input type="checkbox" id="resurface"> Riproponi non completate ogni giorno</label>
          <button id="enableNotifs" class="btn">Abilita notifiche</button>
        </div>
      </details>
      <details>
        <summary>Dati &amp; Backup</summary>
        <div class="grid-compact" style="margin-top:10px">
          <button id="exportTasks" class="btn block">Esporta pulizie</button>
          <label class="file-btn">Importa pulizie
            <input type="file" id="importTasks" accept="application/json">
          </label>
          <button id="exportMyScore" class="btn block">Esporta classifica (utente attivo)</button>
          <label class="file-btn">Importa classifica su utente attivo
            <input type="file" id="importMyScore" accept="application/json">
          </label>
          <button id="backup" class="btn block">Backup completo</button>
          <label class="file-btn">Ripristina backup completo
            <input type="file" id="restoreFile" accept="application/json">
          </label>
          <button id="clearDone" class="btn block">Cancella completate</button>
        </div>
      </details>
      <details>
        <summary>Aggiorna applicazione</summary>
        <div class="grid" style="margin-top:10px">
          <button id="refreshBtn" class="btn">Ricarica applicazione</button>
        </div>
      </details>
    </div>
  </section>
</main>
</div>

<div id="loaderOverlay" class="loader" aria-hidden="true">
  <img src="icons/icon-192.png" alt="" class="loader-logo">
  <span class="sr-only" aria-live="polite">Caricamento…</span>
</div>

<!-- Filters Drawer -->
<div id="filtersDrawer" class="drawer" aria-hidden="true">
  <div class="scrim" id="filtersScrim"></div>
  <div class="panel scroll-area" role="dialog" aria-modal="true" aria-label="Filtri">
    <h3>Filtri</h3>
    <form class="filter-box">
      <div class="filter-grid">
        <label class="full">Cerca
          <input id="f-q" placeholder="Cerca per nome/notes">
        </label>
        <label>Stanza
          <select id="f-room"></select>
        </label>
        <label>Stato
          <select id="f-state">
            <option value="">(tutti)</option>
            <option value="future">Futuro</option>
            <option value="due">In scadenza oggi</option>
            <option value="over">Scaduto</option>
            <option value="done">Completato</option>
          </select>
        </label>
        <label class="check full"><input type="checkbox" id="f-done-today"> Completate oggi</label>
        <label class="check full"><input type="checkbox" id="f-not-done-today"> Non completate oggi</label>
        <label>Data da
          <input type="date" id="f-from">
        </label>
        <label>Data a
          <input type="date" id="f-to">
        </label>
      </div>
      <div class="filter-actions">
        <button class="btn" id="clearFilters" type="button">Pulisci</button>
        <button class="btn primary" id="closeFilters" type="button">Applica</button>
      </div>
    </form>
  </div>
</div>

<!-- Calendar Day drawer -->
<div id="dayDrawer" class="drawer" aria-hidden="true">
  <div class="scrim" id="dayScrim"></div>
  <div class="panel scroll-area" role="dialog" aria-modal="true" aria-label="Pulizie del giorno">
    <h3 id="dayTitle"></h3>
    <div id="dayList"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px;">
      <button id="dayAddBtn" class="btn primary">Nuova</button>
    </div>
  </div>
</div>

<!-- Editor drawer -->
<div id="editorDrawer" class="drawer" aria-hidden="true">
  <div class="scrim" id="editorScrim"></div>
  <div class="panel scroll-area" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
  <header>
    <h3 id="sheetTitle" style="margin:0;flex:1">Nuova pulizia</h3>
    <button id="sheetClose" class="btn">Chiudi</button>
  </header>
  <div class="content">
    <form id="taskForm" class="form-grid">
      <input id="f-id" type="hidden">
      <label class="field full">Nome pulizia
        <input id="f-title" placeholder="Es. Passare l'aspirapolvere" required>
      </label>
      <label class="field full">Descrizione
        <textarea id="f-notes" rows="3" placeholder="Dettagli (opzionale)"></textarea>
      </label>
      <label class="field full">Data inizio
        <input id="f-startAt" type="datetime-local" required>
      </label>
      <label class="field full">Ripetizione
        <input id="f-rep-enabled" class="toggle" type="checkbox">
      </label>
      <div id="repFields" class="full" style="display:none">
        <div class="form-grid">
          <label>Intervallo
            <input id="f-rep-every" type="number" min="1" step="1" value="1">
          </label>
          <label>Unità
            <select id="f-rep-unit">
              <option value="days">Giorni</option>
              <option value="weeks">Settimane</option>
              <option value="months">Mesi</option>
              <option value="hours">Ore</option>
            </select>
          </label>
        </div>
        <div id="repWeekdays" class="weekdays" style="display:none;">
          <label><input type="checkbox" value="0">L</label>
          <label><input type="checkbox" value="1">M</label>
          <label><input type="checkbox" value="2">M</label>
          <label><input type="checkbox" value="3">G</label>
          <label><input type="checkbox" value="4">V</label>
          <label><input type="checkbox" value="5">S</label>
          <label><input type="checkbox" value="6">D</label>
        </div>
      </div>
      <label class="field full">Foto
        <div id="photoZone" class="photo-zone">Trascina o clicca per caricare</div>
        <div id="photoPreview" class="photo-preview">
          <img id="photoImg" alt="Anteprima">
          <button type="button" class="btn" id="photoRemove">Rimuovi</button>
        </div>
        <input id="f-photo" type="file" accept="image/png, image/jpeg" hidden>
      </label>
      <div class="full" style="display:flex; gap:10px; justify-content:flex-end;">
        <button id="btnDelete" type="button" class="btn btn-danger" style="display:none">Elimina</button>
        <button id="btnSave" class="btn primary" type="submit">Salva</button>
      </div>
    </form>
  </div>
  </div>
</div>

<!-- Task full-screen view -->
<div id="taskView" class="task-view" role="dialog" aria-modal="true" aria-hidden="true">
  <header>
    <h3 id="tvTitle" style="margin:0;flex:1"></h3>
    <button id="tvClose" class="btn">Chiudi</button>
  </header>
  <div class="content scroll-area">
    <div id="tvMeta" class="badges"></div>
    <div id="tvNotes" style="margin-top:10px"></div>
    <div id="tvPhotos" class="photos"></div>
    <div id="tvNext" style="margin-top:10px"></div>
    <div id="tvActions" class="actions" style="margin-top:20px"></div>
  </div>
</div>

<!-- Toast container -->
<div id="toastWrap" class="toast-wrap" aria-live="polite" aria-atomic="true"></div>

<script>
/* ===== Stato & storage ===== */
const DBKEY="pulizie-db-v10";
const nowISO=()=>new Date().toISOString();
const todayYMD=()=>new Date().toISOString().slice(0,10);

/* Colori utente: nomi + hex */
const USER_COLORS=[
  {name:"Rosa", hex:"#FF8FA3"},
  {name:"Rosa Chiaro", hex:"#FFB3C1"},
  {name:"Azzurro", hex:"#A0C4FF"},
  {name:"Celeste", hex:"#BDE0FE"},
  {name:"Verde Menta", hex:"#B9FBC0"},
  {name:"Acqua", hex:"#98F5E1"},
  {name:"Albiccocca", hex:"#FFD6A5"},
  {name:"Giallo Chiaro", hex:"#FDFFB6"},
  {name:"Lilla", hex:"#E9B3FF"},
  {name:"Verde Salvia", hex:"#C4F1BE"}
];

/* Palette app */
const APP_PALETTES=[
  {name:"Azzurro", brand:"#A0C4FF", brand2:"#B9FBC0", bg:"#F8F5FF"},
  {name:"Menta", brand:"#B9FBC0", brand2:"#A0C4FF", bg:"#F0FFF4"},
  {name:"Lilla", brand:"#CDB4DB", brand2:"#A0C4FF", bg:"#F8F5FF"},
  {name:"Giallo", brand:"#FFF3B0", brand2:"#A0C4FF", bg:"#FFF9E6"},
  {name:"Pesca", brand:"#FFB3C1", brand2:"#A0C4FF", bg:"#FFF5F7"}
];

const defaults={
  version:10,
  users:[
    {id:"me", name:"Alberto", color:"#A0C4FF", photo:null},
    {id:"partner", name:"Giorgia", color:"#FF8FA3", photo:null}
  ],
  activeUserId:"me",
  appearance:{ palette:APP_PALETTES[0], theme:"system", logo:null },
  settings:{
    remindAt:"09:00",
    resurfaceUnfinished:false,
    rooms:[{name:"Cucina",photo:null},{name:"Soggiorno",photo:null},{name:"Bagno",photo:null},{name:"Camera",photo:null},{name:"Ingresso",photo:null},{name:"Balcone",photo:null},{name:"Altro",photo:null}]
  },
  tasks:[],
  history:[],
  notified:{},
  score:{},
  lastMalusDate:null
};
function migrate(d){
  if(!d.settings?.rooms){ d.settings={...(d.settings||{}), rooms:defaults.settings.rooms}; }
  if(!d.score) d.score={};
  if(!('lastMalusDate' in d)) d.lastMalusDate=null;
  if(!d.users || Array.isArray(d.users)===false){ d.users = defaults.users; d.activeUserId="me"; }
  if(!d.appearance) d.appearance = defaults.appearance;
  if('bgTasks' in (d.appearance||{})) delete d.appearance.bgTasks;
  if(!('theme' in d.appearance)) d.appearance.theme = "system";
  return d;
}
function load(){
  const raw=localStorage.getItem(DBKEY);
  if(!raw){ localStorage.setItem(DBKEY, JSON.stringify(defaults)); return structuredClone(defaults); }
  try{ return migrate(JSON.parse(raw)); }catch{ localStorage.setItem(DBKEY, JSON.stringify(defaults)); return structuredClone(defaults); }
}
let state=load();
const save=()=>localStorage.setItem(DBKEY, JSON.stringify(state));

/* ===== Toast ===== */
const toastWrap=document.getElementById("toastWrap");
function showToast(msg, timeout=2200){
  const t=document.createElement("div"); t.className="toast"; t.textContent=msg;
  toastWrap.appendChild(t);
  setTimeout(()=>{ t.style.opacity="0"; t.style.transition="opacity .3s"; }, timeout);
  setTimeout(()=>{ toastWrap.removeChild(t); }, timeout+350);
}
/* ===== Util/UI ===== */
function byId(id){ return document.getElementById(id); }
function esc(str){
  const map = {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"};
  return String(str).replace(/[&<>"']/g, m => map[m]);
}
let lastFocused=null, trapPanel=null;
function trapFocus(panel){
  lastFocused=document.activeElement;
  trapPanel=panel;
  const focusables=panel.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
  const first=focusables[0], last=focusables[focusables.length-1];
  function loop(e){
    if(e.key!=='Tab') return;
    if(e.shiftKey && document.activeElement===first){ e.preventDefault(); last.focus(); }
    else if(!e.shiftKey && document.activeElement===last){ e.preventDefault(); first.focus(); }
  }
  panel.addEventListener('keydown', loop);
  panel._trapLoop=loop;
  first && first.focus();
}
function releaseFocus(){
  if(trapPanel){
    trapPanel.removeEventListener('keydown', trapPanel._trapLoop);
    trapPanel=null;
  }
  if(lastFocused) lastFocused.focus();
}
const logoEl=byId("appLogo");
const avatarEl=byId("avatar"), whoEl=byId("who");
const addTaskBtn=byId("addTaskBtn");
const refreshBtn = byId("refreshBtn");
if(refreshBtn){
  refreshBtn.addEventListener("click", () => {
    if("caches" in window){
      caches.keys()
        .then(keys => Promise.all(keys.map(k => caches.delete(k))))
        .finally(() => window.location.reload(true));
    }else{
      window.location.reload(true);
    }
  });
}
function activeUser(){ return state.users.find(u=>u.id===state.activeUserId) || state.users[0]; }
function setActiveUser(id){ state.activeUserId=id; save(); renderHeader(); renderAssigneeSelects(); renderUsersList(); renderLeader(); renderHistory(); }

const themeMedia=window.matchMedia('(prefers-color-scheme: dark)');
function updateThemeColor(){
  const c=getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
  document.querySelector('meta[name="theme-color"]').setAttribute('content', c);
}
function luminance(hex){
  const c = hex.replace('#','');
  const r = parseInt(c.slice(0,2),16)/255;
  const g = parseInt(c.slice(2,4),16)/255;
  const b = parseInt(c.slice(4,6),16)/255;
  const a = [r,g,b].map(v=> v<=0.03928 ? v/12.92 : Math.pow((v+0.055)/1.055,2.4));
  return 0.2126*a[0] + 0.7152*a[1] + 0.0722*a[2];
}
function contrastRatio(l1,l2){
  const brightest=Math.max(l1,l2), darkest=Math.min(l1,l2);
  return (brightest+0.05)/(darkest+0.05);
}
function bestTextColor(bg){
  const l = luminance(bg);
  const white = contrastRatio(1,l);
  const black = contrastRatio(0,l);
  return white>=black? '#FFFFFF':'#000000';
}
function updateTextContrast(){
  const root=document.documentElement;
  const bg=getComputedStyle(root).getPropertyValue('--bg-color').trim();
  const surface=getComputedStyle(root).getPropertyValue('--surface-color').trim();
  const text=bestTextColor(bg);
  root.style.setProperty('--text-color', text);
  root.style.setProperty('--icon-on-bg', bestTextColor(bg));
  root.style.setProperty('--icon-on-surface', bestTextColor(surface));
  root.style.setProperty('--placeholder-color', text==='#000000'? 'rgba(0,0,0,0.6)':'rgba(255,255,255,0.6)');
  document.querySelectorAll('.btn, .tab.active, .nav-tab.active').forEach(el=>{
    const bgc=getComputedStyle(el).getPropertyValue('--btn-bg-color').trim()||bg;
    el.style.setProperty('--btn-text-color', bestTextColor(bgc));
  });
}
function applyTheme(t){
  document.documentElement.removeAttribute('data-theme');
  if(t==='light') document.documentElement.setAttribute('data-theme','light');
  else if(t==='dark') document.documentElement.setAttribute('data-theme','dark');
  const isDark = t==='dark' || (t==='system' && themeMedia.matches);
  const statusBar=document.querySelector('meta[name="apple-mobile-web-app-status-bar-style"]');
  if(statusBar) statusBar.setAttribute('content', isDark? 'black':'default');
  updateThemeColor();
  updateTextContrast();
}
themeMedia.addEventListener('change', ()=>{ if(state.appearance.theme==='system'){ applyTheme('system'); }});

function updateVH(){
  const vh=window.visualViewport? window.visualViewport.height : window.innerHeight;
  document.documentElement.style.setProperty('--vh', vh+"px");
  const active=document.activeElement;
  if(active && typeof active.scrollIntoView==='function'){
    active.scrollIntoView({block:'center'});
  }
}
if(window.visualViewport){
  visualViewport.addEventListener('resize', updateVH);
  visualViewport.addEventListener('scroll', updateVH);
}
window.addEventListener('resize', updateVH);
updateVH();

/* Palette */
function applyPalette(p){
  const root=document.documentElement;
  root.style.setProperty("--accent-color", p.brand);
  root.style.setProperty("--accent-color-2", p.brand2);
  root.style.setProperty("--bg-light", p.bg);
  root.style.setProperty("--text-on-accent2", bestTextColor(p.brand2));
  updateThemeColor();
  updateTextContrast();
}

/* Header, logo */
function renderHeader(){
  const u=activeUser();
  whoEl.textContent=u?.name||"Utente";
  if(u?.photo){ avatarEl.src=u.photo; avatarEl.style.background="transparent"; }
  else { avatarEl.removeAttribute("src"); avatarEl.style.background=u?.color||"#ccc"; }
  logoEl.src = state.appearance.logo || "icons/icon-192.png";
  logoEl.style.background="var(--accent-color)";
}

/* ===== Date helpers (gg-mm-aa) ===== */
function fmtDMY(d){ // gg-mm-aa
  const dd=String(d.getDate()).padStart(2,"0");
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const yy=String(d.getFullYear()).slice(-2);
  return `${dd}-${mm}-${yy}`;
}
function fmtDMYHM(d){ // gg-mm-aa hh:mm
  const hh=String(d.getHours()).padStart(2,"0"), mi=String(d.getMinutes()).padStart(2,"0");
  return `${fmtDMY(d)} ${hh}:${mi}`;
}
function ymdToDMYStr(s){ // "YYYY-MM-DD" -> "gg-mm-aa"
  if(!s) return "";
  const [Y,M,D]=s.split("-");
  return `${D}-${M}-${String(Y).slice(-2)}`;
}

/* ===== Scheduling / Status ===== */
function parseLocal(dt){ return dt ? new Date(dt) : null; }
function addInterval(d,n,u){
  const nd=new Date(d);
  const step = Number(n);
  if(u==="hours") nd.setHours(nd.getHours()+step);
  else if(u==="days") nd.setDate(nd.getDate()+step);
  else if(u==="weeks") nd.setDate(nd.getDate()+7*step);
  else nd.setMonth(nd.getMonth()+step);
  return nd;
}
function nextOccurrenceFromStart(start,every,unit,ref,weekdays=[]){
  if(!start) return null;
  let cur=new Date(start);
  if(!every||every<1) every=1;
  if(unit==="weeks" && weekdays.length){
    const baseDow=(cur.getDay()+6)%7;
    const baseWeekStart=new Date(cur); baseWeekStart.setDate(cur.getDate()-baseDow);
    let weekStart=new Date(baseWeekStart);
    let guard=0;
    while(guard++<800){
      const diffWeeks=Math.round((weekStart-baseWeekStart)/604800000);
      if(diffWeeks%every===0){
        for(const wd of weekdays){
          const cand=new Date(weekStart);
          cand.setDate(weekStart.getDate()+wd);
          cand.setHours(cur.getHours(),cur.getMinutes(),0,0);
          if(cand>=cur && cand>=ref) return cand;
        }
      }
      weekStart.setDate(weekStart.getDate()+7);
    }
    return null;
  }
  if(unit==="hours"){
    let guard=0;
    while(cur<ref && guard++<800){ cur=addInterval(cur,every,"hours"); }
    return cur;
  }
  if(cur>=ref) return cur;
  let guard=0;
  while(cur<ref && guard++<800){ cur=addInterval(cur,every,unit); }
  return cur;
}
function isSameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
function statusForTask(t){
  const now=new Date();
  const start=parseLocal(t.startAt);
  if(!start) return { next:null, code: t.done?"done":"future" };
  const next=t.repeat?.enabled ? nextOccurrenceFromStart(start, t.repeat.every, t.repeat.unit, now, t.repeat.weekdays||[]) : start;
  if(t.done) return { next, code:"done" };
  if(!next) return { next:null, code:"future" };
  if(isSameDay(next, now)) return { next, code:"due" };
  if(next < now) return { next, code:"over" };
  return { next, code:"future" };
}

/* ===== Occorrenze per Calendario ===== */
function occursOnDay(task, day){
  const start = parseLocal(task.startAt);
  if(!start) return false;
  const sDay = new Date(start.getFullYear(), start.getMonth(), start.getDate());
  const dDay = new Date(day.getFullYear(), day.getMonth(), day.getDate());

  if(!task.repeat?.enabled){
    return isSameDay(sDay, dDay);
  }
  const every = Math.max(1, parseInt(task.repeat.every||"1",10));
  const unit = task.repeat.unit;

  if(unit==="hours"){
    const dayStart=new Date(dDay); dayStart.setHours(0,0,0,0);
    const dayEnd=new Date(dayStart); dayEnd.setDate(dayEnd.getDate()+1);
    let cur=new Date(start);
    let guard=0;
    if(cur>=dayEnd) return false;
    while(cur<dayStart && guard++<800){ cur=addInterval(cur,every,"hours"); }
    return cur>=dayStart && cur<dayEnd;
  }

  if(dDay < sDay) return false;

  if(unit==="days"){
    const diff = Math.round((dDay - sDay)/86400000);
    return diff % every === 0;
  }else if(unit==="weeks"){
    const wds = task.repeat.weekdays || [];
    const dDow = (dDay.getDay()+6)%7;
    if(wds.length && !wds.includes(dDow)) return false;
    const startDow = (sDay.getDay()+6)%7;
    const startWeekStart=new Date(sDay); startWeekStart.setDate(sDay.getDate()-startDow);
    const dWeekStart=new Date(dDay); dWeekStart.setDate(dDay.getDate()-dDow);
    const diffWeeks = Math.round((dWeekStart - startWeekStart)/(86400000*7));
    return diffWeeks % every === 0;
  }else{
    const diffMonths = (dDay.getFullYear()*12 + dDay.getMonth()) - (sDay.getFullYear()*12 + sDay.getMonth());
    if(diffMonths % every !== 0) return false;
    const target = new Date(sDay);
    target.setMonth(sDay.getMonth() + diffMonths);
    const lastDay = new Date(target.getFullYear(), target.getMonth()+1, 0).getDate();
    const dayNum = Math.min(sDay.getDate(), lastDay);
    const clamp = new Date(target.getFullYear(), target.getMonth(), dayNum);
    return isSameDay(clamp, dDay);
  }
}

/* ===== Tabs Da Fare & Filtri ===== */
let scope="oggi";
document.querySelectorAll(".tab").forEach(b=> b.addEventListener("click", ()=>{
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
  scope=b.dataset.scope;
  renderTasks();
}));

const filtersDrawer=byId("filtersDrawer"), filtersScrim=byId("filtersScrim"), closeFilters=byId("closeFilters"), toggleFilters=byId("toggleFilters"), chipsEl=byId("activeChips");
function openFilters(){
  filtersDrawer.classList.add("open");
  filtersDrawer.setAttribute("aria-hidden","false");
  trapFocus(filtersDrawer.querySelector(".panel"));
}
function closeFiltersDrawer(){
  filtersDrawer.classList.remove("open");
  filtersDrawer.setAttribute("aria-hidden","true");
  releaseFocus();
}
toggleFilters.addEventListener("click", openFilters);
filtersScrim.addEventListener("click", closeFiltersDrawer);
closeFilters.addEventListener("click", ()=>{ closeFiltersDrawer(); renderChips(); renderTasks(); });
document.addEventListener("keydown", e=>{ if(e.key==="Escape" && filtersDrawer.classList.contains("open")) closeFiltersDrawer(); });
const filterInputs={
  q: byId("f-q"), room: byId("f-room"),
  state: byId("f-state"), doneToday: byId("f-done-today"), notDoneToday: byId("f-not-done-today"),
  from: byId("f-from"), to: byId("f-to")
};
Object.values(filterInputs).forEach(el=> el.addEventListener("input", ()=>{ renderChips(); }));

function renderRoomFilters(){
  filterInputs.room.innerHTML=`<option value="">(tutte)</option>` + state.settings.rooms.map(r=>`<option value="${esc(r.name)}">${esc(r.name)}</option>`).join("");
}
function renderChips(){
  const chips=[];
  const {q,room,state,doneToday,notDoneToday,from,to}=filterInputs;
  if(q.value) chips.push(`testo:“${q.value}”`);
  if(room.value) chips.push(`stanza:${room.value}`);
  if(state.value) chips.push(`stato:${state.value}`);
  if(doneToday.checked) chips.push("completate:oggi");
  if(notDoneToday.checked) chips.push("non completate:oggi");
  if(from.value||to.value) chips.push(`data:${from.value? ymdToDMYStr(from.value):".."}→${to.value? ymdToDMYStr(to.value):".."}`);
  chipsEl.innerHTML=chips.map(c=>`<span class="chip">${esc(c)}</span>`).join("");
}

/* ===== LISTA PULIZIE ===== */
const listEl=byId("list"), emptyEl=byId("empty");
function baseTasksForScope(){
  const tasks=[...state.tasks];
  if(scope==="oggi"){
    const todayStart=new Date(todayYMD()+"T00:00:00");
    return tasks.filter(t=>{
      if(t.done) return false;
      const s=statusForTask(t);
      if(s.code==="due") return true;
      if(state.settings.resurfaceUnfinished){
        const start=parseLocal(t.startAt); if(!start) return false;
        if(t.repeat?.enabled){
          const prev=nextOccurrenceFromStart(start, t.repeat.every, t.repeat.unit, new Date(todayStart - 1), t.repeat.weekdays||[]);
          if(prev && prev < todayStart) return true;
        } else if(start < todayStart){ return true; }
      }
      return false;
    });
  }
  return tasks;
}
function applyFilters(list){
  const {q,room,state,doneToday,notDoneToday,from,to}=filterInputs;
  const qv=q.value.trim().toLowerCase();
  const fromD=from.value? new Date(from.value+"T00:00:00"):null;
  const toD=to.value? new Date(to.value+"T23:59:59"):null;
  return list.filter(t=>{
    const s=statusForTask(t);
    if(qv && !((t.title||t.name||"").toLowerCase().includes(qv) || (t.notes||"").toLowerCase().includes(qv))) return false;
    if(room.value && t.room!==room.value) return false;
    if(state.value && s.code!==state.value) return false;
    const last = t.lastDone ? new Date(t.lastDone) : null;
    const isDoneToday = last ? isSameDay(last,new Date()) : false;
    if(doneToday.checked && !isDoneToday) return false;
    if(notDoneToday.checked && isDoneToday) return false;
    if(fromD || toD){
      if(!s.next) return false;
      if(fromD && s.next < fromD) return false;
      if(toD && s.next > toD) return false;
    }
    return true;
  });
}
function renderTasks(){
  renderRoomSelect(); renderAssigneeSelects(); renderRoomFilters();
  listEl.innerHTML=""; emptyEl.style.display="none";
  const tasks = applyFilters(baseTasksForScope()).sort((a,b)=>{
    const sa=statusForTask(a), sb=statusForTask(b);
    const na=sa.next||new Date("9999-12-31"), nb=sb.next||new Date("9999-12-31");
    return (a.done-b.done)||(a.priority-b.priority)||(na-nb);
  });
  if(!tasks.length){ emptyEl.style.display="block"; return; }
  for(const t of tasks){
    const s=statusForTask(t);
    const li=document.createElement("li"); li.className=`task ${s.code}`; li.dataset.id=t.id;

    // Accessibilità + interazioni su tutta la card
    li.setAttribute("tabindex", "0");
    li.setAttribute("role", "button");

    const head=document.createElement("div"); head.className="task-head";
    const chk=document.createElement("div"); chk.className="chk";
    const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=!!t.done;
    cb.addEventListener("click", ev=>ev.stopPropagation()); // non apre/chiude la card
    cb.addEventListener("change", ()=>{
      const userName = t.assignee || activeUser().name;
      const prev = t.lastScore || 0;
      if(cb.checked){
        t.done = true;
        t.lastDone = nowISO();
        const newScore = computeScoreFor(t, new Date());
        const delta = newScore - prev;
        t.lastScore = newScore;
        applyScoreDelta(userName, delta, "aggiornamento punteggio (chiusura)", t);
        showToast("✅ Pulizia completata");
      }else{
        t.done = false;
        t.lastDone = null;
        const delta = - (t.lastScore || 0);
        t.lastScore = 0;
        applyScoreDelta(userName, delta, "rimozione punteggio (riaperta)", t);
        showToast("↩️ Pulizia riaperta");
      }
      save(); renderTasks(); renderLeader(); renderHistory(); renderCalendar();
    });
    chk.appendChild(cb);

    const headMain=document.createElement("div"); headMain.className="head-main";
    const title=document.createElement("div"); title.className="title"; title.textContent=t.title || t.name;
    const notesLine=document.createElement("div"); notesLine.className="notes-line"; const photoTag=t.photo?" 📷":""; notesLine.textContent = (t.notes||"")+photoTag;
    headMain.appendChild(title); headMain.appendChild(notesLine);
    const dateBadge=document.createElement("div"); dateBadge.className="date-badge"; dateBadge.textContent = s.next ? fmtDMY(s.next) : "--";
    const chev=document.createElement("div"); chev.className="chev"; chev.innerHTML=`<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" d="M9 6l6 6-6 6"/></svg>`;
    head.appendChild(chk); head.appendChild(headMain); head.appendChild(dateBadge); head.appendChild(chev);
    li.appendChild(head);

    // Apri la pagina dettagli cliccando ovunque sulla card (tranne controlli interattivi)
    li.addEventListener("click", (ev)=>{
      const tag = (ev.target.tagName || "").toLowerCase();
      if (tag === "input" || tag === "button" || tag === "select" || tag === "textarea" || ev.target.closest("button, input, select, textarea")) return;
      openTaskView(t);
    });
    // Supporto tastiera
    li.addEventListener("keydown", (ev)=>{
      if(ev.key === "Enter" || ev.key === " "){
        ev.preventDefault();
        openTaskView(t);
      }
    });

    listEl.appendChild(li);
  }
}

/* ===== EDITOR ===== */
const editorDrawer=byId("editorDrawer"), editorScrim=byId("editorScrim"), sheetTitle=byId("sheetTitle"), sheetClose=byId("sheetClose");
const form=byId("taskForm");
const fId=byId("f-id"), fTitle=byId("f-title"), fStartAt=byId("f-startAt"),
      fRepEnabled=byId("f-rep-enabled"), fRepEvery=byId("f-rep-every"), fRepUnit=byId("f-rep-unit"),
      fNotes=byId("f-notes"), repFields=byId("repFields"), repWeekdays=byId("repWeekdays"),
      photoInput=byId("f-photo"), photoZone=byId("photoZone"), photoPreview=byId("photoPreview"),
      photoImg=byId("photoImg"), photoRemove=byId("photoRemove"),
      fRoomSel=byId("f-roomSel"), fAssignee=byId("f-assignee"),
      btnSave=byId("btnSave"), btnDelete=byId("btnDelete");
const taskView=byId("taskView"), tvTitle=byId("tvTitle"), tvClose=byId("tvClose"),
      tvMeta=byId("tvMeta"), tvNotes=byId("tvNotes"), tvPhotos=byId("tvPhotos"),
      tvNext=byId("tvNext"), tvActions=byId("tvActions");
let photoData=null;

function renderRoomSelect(){
  if(!fRoomSel) return;
  fRoomSel.innerHTML = `<option value="">(Nessuna)</option>` + state.settings.rooms.map(r=>`<option value="${esc(r.name)}">${esc(r.name)}</option>`).join("");
}
function renderAssigneeSelects(){
  if(!fAssignee) return;
  const opts = state.users.map(u=>`<option value="${esc(u.name)}">${esc(u.name)}</option>`).join("");
  fAssignee.innerHTML = `<option value="">(nessuno)</option>`+opts;
}

if(fNotes){
  fNotes.addEventListener('input', ()=>{ fNotes.style.height='auto'; fNotes.style.height=fNotes.scrollHeight+'px'; });
}
fRepEnabled.addEventListener('change', ()=>{
  repFields.style.display = fRepEnabled.checked ? 'block' : 'none';
  if(!fRepEnabled.checked){
    fRepEvery.value = 1; fRepUnit.value = 'days';
    repWeekdays.style.display='none';
    repWeekdays.querySelectorAll('input').forEach(cb=>cb.checked=false);
  }
});
fRepUnit.addEventListener('change', ()=>{
  repWeekdays.style.display = fRepUnit.value==='weeks' ? 'flex' : 'none';
});
function getSelectedWeekdays(){
  return Array.from(repWeekdays.querySelectorAll('input:checked')).map(cb=>parseInt(cb.value,10));
}
photoZone.addEventListener('click', ()=> photoInput.click());
photoZone.addEventListener('dragover', e=>{ e.preventDefault(); photoZone.classList.add('hover'); });
photoZone.addEventListener('dragleave', ()=> photoZone.classList.remove('hover'));
photoZone.addEventListener('drop', e=>{ e.preventDefault(); photoZone.classList.remove('hover'); handlePhotoFile(e.dataTransfer.files[0]); });
photoInput.addEventListener('change', ()=> handlePhotoFile(photoInput.files[0]));
photoRemove.addEventListener('click', ()=>{ photoData=null; photoPreview.style.display='none'; photoInput.value=''; });
function handlePhotoFile(file){
  if(!file) return;
  if(!/image\/(jpeg|png)/.test(file.type)){ alert('Solo immagini JPG/PNG'); return; }
  if(file.size > 5*1024*1024){ alert('Max 5MB'); return; }
  const r=new FileReader();
  r.onload=()=>{ photoData=r.result; photoImg.src=photoData; photoPreview.style.display='block'; };
  r.readAsDataURL(file);
}
function openEditor(task=null){
  editorDrawer.classList.add("open");
  editorDrawer.setAttribute("aria-hidden","false");
  trapFocus(editorDrawer.querySelector(".panel"));
  if(task){
    sheetTitle.textContent="Modifica pulizia";
    fId.value=task.id;
    fTitle.value=task.title||task.name||"";
    fNotes.value=task.notes||task.description||"";
    fStartAt.value=task.startAt||task.start_at||new Date().toISOString().slice(0,16);
    fRepEnabled.checked=!!task.repeat?.enabled;
    fRepEvery.value=task.repeat?.every||1;
    fRepUnit.value=task.repeat?.unit||"days";
    repFields.style.display = fRepEnabled.checked ? "block" : "none";
    repWeekdays.style.display = (fRepUnit.value==="weeks") ? "flex" : "none";
    const wds = task.repeat?.weekdays || [];
    repWeekdays.querySelectorAll('input').forEach(cb=>{ cb.checked = wds.includes(parseInt(cb.value,10)); });
    photoData = task.photo || null;
    if(photoData){
      photoImg.src=photoData; photoPreview.style.display="block";
    }else{ photoPreview.style.display="none"; photoInput.value=""; }
    btnDelete.style.display="inline-flex";
  }else{
    sheetTitle.textContent="Nuova pulizia";
    fId.value="";
    fTitle.value=""; fNotes.value="";
    fStartAt.value=new Date().toISOString().slice(0,16);
    fRepEnabled.checked=false; fRepEvery.value=1; fRepUnit.value="days";
    repFields.style.display="none"; repWeekdays.style.display="none";
    repWeekdays.querySelectorAll('input').forEach(cb=>cb.checked=false);
    photoData=null; photoInput.value=""; photoPreview.style.display="none";
    btnDelete.style.display="none";
  }
}
function closeEditor(){
  editorDrawer.classList.remove("open");
  editorDrawer.setAttribute("aria-hidden","true");
  releaseFocus();
}
sheetClose.addEventListener("click", closeEditor);
editorScrim.addEventListener("click", closeEditor);
document.addEventListener("keydown", e=>{ if(e.key==="Escape" && editorDrawer.classList.contains("open")) closeEditor(); });

function openTaskView(task){
  tvTitle.textContent = task.title || task.name;
  tvMeta.innerHTML = "";
  if(task.repeat?.enabled){
    let unitLabel = task.repeat.unit==="days"?"giorni":task.repeat.unit==="weeks"?"settimane":task.repeat.unit==="months"?"mesi":"ore";
    let extra = "";
    if(task.repeat.unit==="weeks" && task.repeat.weekdays && task.repeat.weekdays.length){
      const labs=["L","M","M","G","V","S","D"];
      extra = ` (${task.repeat.weekdays.map(i=>labs[i]).join(",")})`;
    }
    tvMeta.innerHTML += `<span>Ogni ${task.repeat.every} ${unitLabel}${extra}</span>`;
  }else{
    tvMeta.innerHTML += `<span>Singolo</span>`;
  }
  tvNotes.textContent = task.notes || task.description || "";
  tvPhotos.innerHTML = "";
  if(task.photo){
    const im=document.createElement("img"); im.src=task.photo; tvPhotos.appendChild(im);
  }else if(task.photos && task.photos.length){
    task.photos.forEach(src=>{ const im=document.createElement("img"); im.src=src; tvPhotos.appendChild(im); });
  }
  const s = statusForTask(task);
  tvNext.innerHTML = `Prossima occorrenza: <strong>${s.next? fmtDMYHM(s.next) : "--"}</strong>`;
  tvActions.innerHTML = "";
  const editBtn=document.createElement("button"); editBtn.className="btn"; editBtn.textContent="Modifica";
  editBtn.addEventListener("click", ()=>{ closeTaskView(); openEditor(task); });
  tvActions.appendChild(editBtn);
  taskView.style.display="flex";
  taskView.setAttribute("aria-hidden","false");
}
function closeTaskView(){
  taskView.style.display="none";
  taskView.setAttribute("aria-hidden","true");
}
tvClose.addEventListener("click", closeTaskView);

btnDelete.addEventListener("click", ()=>{
  if(!fId.value) return;
  if(confirm("Eliminare questa pulizia?")){
    const t = state.tasks.find(x=>x.id===fId.value);
    if(t && (t.lastScore||0)){
      const userName = t.assignee || activeUser().name;
      applyScoreDelta(userName, -(t.lastScore||0), "rimozione punteggio (task eliminato)", t);
    }
    state.tasks = state.tasks.filter(t=>t.id!==fId.value);
    save(); closeEditor(); renderTasks(); renderCalendar(); renderLeader(); renderHistory();
    showToast("🗑️ Pulizia eliminata");
  }
});

/* Foto helpers */
function fileToDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); }); }

form.addEventListener("submit", (e)=>{
  e.preventDefault();
  const prevTask = state.tasks.find(t=>t.id===fId.value);
  const data={
    id: fId.value || crypto.randomUUID(),
    title: fTitle.value.trim(),
    room: prevTask?.room || "",
    priority: prevTask?.priority || 2,
    assignee: prevTask?.assignee || "",
    startAt: fStartAt.value || null,
    repeat:{
      enabled:fRepEnabled.checked,
      every:fRepEnabled.checked? parseInt(fRepEvery.value||"1",10) : 1,
      unit:fRepEnabled.checked? fRepUnit.value : "days",
      weekdays:fRepEnabled.checked && fRepUnit.value==="weeks" ? getSelectedWeekdays() : []
    },
    notes: fNotes.value.trim(),
    photo: photoData,
    createdAt: fId.value ? prevTask?.createdAt : nowISO(),
    lastDone: fId.value ? (prevTask?.lastDone || null) : null,
    lastScore: fId.value ? (prevTask?.lastScore || 0) : 0,
    done: fId.value ? (prevTask?.done || false) : false
  };

  const idx=state.tasks.findIndex(t=>t.id===data.id);
  if(idx===-1){ state.tasks.push(data); showToast("➕ Pulizia aggiunta"); }
  else { state.tasks[idx]={...state.tasks[idx], ...data}; showToast("💾 Modifiche salvate"); }

  photoInput.value=""; photoPreview.style.display='none'; photoData=null;
  save(); closeEditor(); renderTasks(); renderCalendar();
});

/* ===== Scoring ===== */
const leaderEl=byId("leader"), historyList=byId("historyList");
function addHistory(entry){ state.history.push(entry); save(); }
function addScore(userName, delta, reason, task){
  const u = state.users.find(u=>u.name===userName);
  const id = u ? u.id : state.activeUserId;
  state.score[id] = (state.score[id]||0) + delta;
  addHistory({ when: nowISO(), userId:id, userName: u?u.name:userName, delta, reason, taskTitle: task?.title||"", taskId: task?.id||null });
}
function computeScoreFor(t, whenDate){
  const s = statusForTask(t);
  if(!s.next) return 5;
  const wd=new Date(whenDate), n=new Date(s.next);
  const startDay=new Date(n.getFullYear(), n.getMonth(), n.getDate());
  const doneDay=new Date(wd.getFullYear(), wd.getMonth(), wd.getDate());
  const diffDays=Math.round((doneDay - startDay)/86400000);
  if(diffDays===0) return 10;
  if(diffDays<0)  return 5;
  return 2;
}
function applyScoreDelta(userName, delta, reason, task){
  if(delta===0) return;
  addScore(userName, delta, reason, task);
}
function applyDailyMalus(){
  const today = todayYMD();
  if(state.lastMalusDate===today) return;
  for(const t of state.tasks){
    const s=statusForTask(t);
    if(s.code==="over" && !t.done){
      const name=t.assignee||activeUser().name;
      addScore(name, -5, "malus: pulizia ancora in ritardo", t);
    }
  }
  state.lastMalusDate=today; save();
}
function renderLeader(){
  const rows = state.users.map(u=>({u, pts: state.score[u.id]||0}));
  rows.sort((a,b)=>b.pts-a.pts);
  leaderEl.innerHTML="";
  for(const r of rows){
    const row=document.createElement("div"); row.className="row";
    const img=document.createElement("img"); img.className="avatar"; img.style.width="28px"; img.style.height="28px";
    if(r.u.photo) img.src=r.u.photo; else { img.style.background=r.u.color; }
    const name=document.createElement("strong"); name.textContent=r.u.name;
    const pts=document.createElement("div"); pts.className="pts"; pts.textContent=r.pts+" pt";
    row.appendChild(img); row.appendChild(name); row.appendChild(pts);
    leaderEl.appendChild(row);
  }
}
function renderHistory(){
  const events=[...state.history].sort((a,b)=> new Date(b.when)-new Date(a.when));
  historyList.innerHTML = events.map(ev=>{
    const d=new Date(ev.when);
    const ds=fmtDMYHM(d);
    const sign = ev.delta>=0 ? "+" : "";
    const cls = ev.delta>=0 ? "pos" : "neg";
    return `<div class="event">
<span class="delta ${cls}">${sign}${ev.delta}</span>
<strong>${esc(ev.userName)}</strong>
<span>— ${esc(ev.reason)}</span>
${ev.taskTitle? `<em> (${esc(ev.taskTitle)})</em>`:""}
<span style="margin-left:auto">${ds}</span>
</div>`;
  }).join("") || "<div class='muted'>Ancora nessun evento.</div>";
}

/* ===== Impostazioni: Utenti ===== */
const usersList=byId("usersList"), activeUserSel=byId("activeUser"), swapToActive=byId("swapToActive");
const uName=byId("u-name"), uColor=byId("u-color"), uPhoto=byId("u-photo"), uAdd=byId("u-add");
function renderColorOptions(sel, currentHex){
  sel.innerHTML = USER_COLORS.map(c=>{
    const selected = c.hex===currentHex ? "selected" : "";
    return `<option value="${c.name}" data-hex="${c.hex}" ${selected}>${c.name}</option>`;
  }).join("");
}
function colorHexFromName(name){
  const f = USER_COLORS.find(c=>c.name===name);
  return f ? f.hex : USER_COLORS[0].hex;
}
function renderUsersList(){
  activeUserSel.innerHTML = state.users.map(u=>`<option value="${u.id}" ${u.id===state.activeUserId?"selected":""}>${esc(u.name)}</option>`).join("");
  usersList.innerHTML="";
  state.users.forEach(u=>{
    const wrap=document.createElement("div"); wrap.className="row"; wrap.style.gap="12px";
    const img=document.createElement("img"); img.className="avatar"; img.style.width="32px"; img.style.height="32px"; if(u.photo) img.src=u.photo; else img.style.background=u.color;
    const name=document.createElement("div"); name.textContent=u.name;
    const colorSel=document.createElement("select"); colorSel.style.minWidth="160px";
    renderColorOptions(colorSel, u.color);
    colorSel.addEventListener("change", ()=>{
      const hex = colorHexFromName(colorSel.value);
      u.color = hex; save(); renderUsersList(); renderHeader(); renderLeader(); showToast("🎨 Colore utente aggiornato");
    });
    const fileLbl=document.createElement("label"); fileLbl.className="btn"; fileLbl.textContent="Foto"; const file=document.createElement("input"); file.type="file"; file.accept="image/*"; file.style.display="none"; fileLbl.appendChild(file);
    const del=document.createElement("button"); del.className="btn"; del.textContent="Rimuovi";
    wrap.appendChild(img); wrap.appendChild(name); wrap.appendChild(colorSel); wrap.appendChild(fileLbl); wrap.appendChild(del);
    usersList.appendChild(wrap);
    file.addEventListener("change", async e=>{ const f=e.target.files[0]; if(!f) return; const data=await fileToDataURL(f); u.photo=data; save(); renderHeader(); renderUsersList(); renderLeader(); renderHistory(); showToast("📷 Foto utente aggiornata"); });
    del.addEventListener("click", ()=>{ if(state.users.length<=1) return alert("Deve esserci almeno un utente."); if(!confirm("Rimuovere utente?")) return; state.users=state.users.filter(x=>x.id!==u.id); if(state.activeUserId===u.id) state.activeUserId=state.users[0].id; save(); renderHeader(); renderUsersList(); renderAssigneeSelects(); renderLeader(); renderHistory(); showToast("Utente rimosso"); });
  });
}
renderColorOptions(uColor, USER_COLORS[2].hex);
uAdd.addEventListener("click", async ()=>{
  const name=uName.value.trim(); if(!name) return;
  const selectedHex = colorHexFromName(uColor.value);
  let photo=null; if(uPhoto.files[0]) photo=await fileToDataURL(uPhoto.files[0]);
  state.users.push({id:crypto.randomUUID(), name, color:selectedHex, photo});
  uName.value=""; uPhoto.value="";
  renderColorOptions(uColor, USER_COLORS[2].hex);
  save(); renderUsersList(); renderAssigneeSelects(); renderLeader(); showToast("👤 Utente aggiunto");
});
swapToActive.addEventListener("click", ()=>{ setActiveUser(activeUserSel.value); showToast("Utente attivo cambiato"); });

/* ===== Impostazioni: Stanze ===== */
const roomsList=byId("roomsList"), rName=byId("r-name"), rPhoto=byId("r-photo"), rAdd=byId("r-add");
function renderRooms(){
  roomsList.innerHTML="";
  state.settings.rooms.forEach((r,i)=>{
    const item=document.createElement("div"); item.className="row";
    const name=document.createElement("strong"); name.textContent=r.name;
    const img=document.createElement("img"); img.className="avatar"; img.style.width="32px"; img.style.height="32px"; if(r.photo) img.src=r.photo; else img.style.background="#ddd";
    const fileLbl=document.createElement("label"); fileLbl.className="btn"; fileLbl.textContent="Foto"; const file=document.createElement("input"); file.type="file"; file.accept="image/*"; file.style.display="none"; fileLbl.appendChild(file);
    const del=document.createElement("button"); del.className="btn"; del.textContent="Rimuovi";
    item.appendChild(img); item.appendChild(name); item.appendChild(fileLbl); item.appendChild(del);
    roomsList.appendChild(item);
    file.addEventListener("change", async e=>{ const f=e.target.files[0]; if(!f) return; const data=await fileToDataURL(f); state.settings.rooms[i].photo=data; save(); renderRooms(); showToast("📷 Foto stanza aggiornata"); });
    del.addEventListener("click", ()=>{ if(!confirm("Rimuovere stanza?")) return; const name=state.settings.rooms[i].name; state.settings.rooms.splice(i,1); state.tasks.forEach(t=>{ if(t.room===name) t.room=""; }); save(); renderRooms(); renderRoomSelect(); renderTasks(); renderCalendar(); showToast("Stanza rimossa"); });
  });
}
rAdd.addEventListener("click", async ()=>{
  const name=rName.value.trim(); if(!name) return;
  let photo=null; if(rPhoto.files[0]) photo=await fileToDataURL(rPhoto.files[0]);
  state.settings.rooms.push({name, photo});
  rName.value=""; rPhoto.value="";
  save(); renderRooms(); renderRoomSelect(); renderTasks(); renderCalendar(); showToast("🏠 Stanza aggiunta");
});

/* ===== Aspetto ===== */
const appPalettesEl=byId("appPalettes"), themeSelect=byId("themeSelect");
function renderAppPalettes(){
  appPalettesEl.innerHTML="";
  APP_PALETTES.forEach(p=>{
    const b=document.createElement("button");
    b.className="btn"; b.textContent=p.name;
    b.style.background=p.brand;
    b.style.borderColor=p.brand;
    b.addEventListener("click", ()=>{ state.appearance.palette=p; save(); applyPalette(p); renderHeader(); showToast("🎨 Palette applicata"); });
    appPalettesEl.appendChild(b);
  });
}
themeSelect.addEventListener("change", ()=>{
  state.appearance.theme=themeSelect.value;
  save();
  applyTheme(state.appearance.theme);
});

/* ===== Notifiche & Backup ===== */
byId("enableNotifs").addEventListener("click", requestNotifs);
function requestNotifs(){ if(!("Notification" in window)){ alert("Notifiche non supportate"); return; } if(Notification.permission==="granted"){ showToast("🔔 Notifiche già abilitate"); return; } Notification.requestPermission().then(p=>{ if(p==="granted"){ showToast("🔔 Notifiche abilitate"); }}); }
const remindAt=byId("remindAt"), resurface=byId("resurface");
remindAt.value = state.settings.remindAt||"09:00"; resurface.checked = !!state.settings.resurfaceUnfinished;
remindAt.addEventListener("change", ()=>{ const v=remindAt.value.trim(); if(/^\d{2}:\d{2}$/.test(v)){ state.settings.remindAt=v; save(); showToast("⏰ Ora promemoria aggiornata"); } else { alert("Usa HH:MM"); remindAt.value=state.settings.remindAt||"09:00"; } });
resurface.addEventListener("change", ()=>{ state.settings.resurfaceUnfinished=resurface.checked; save(); showToast(resurface.checked?"🧼 Riproponi attivo":"🧼 Riproponi disattivato"); });

/* Export/Import parziali */
const exportTasksBtn=byId("exportTasks");
const importTasksInput=byId("importTasks");
const exportMyScoreBtn=byId("exportMyScore");
const importMyScoreInput=byId("importMyScore");
exportTasksBtn.addEventListener("click", ()=>{
  const payload = JSON.stringify({version: state.version, tasks: state.tasks}, null, 2);
  const file=new File([payload],"pulizie-tasks-"+todayYMD()+".json",{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(file); a.download=file.name; a.click(); URL.revokeObjectURL(a.href);
  showToast("⬇️ Esportate solo le pulizie");
});
importTasksInput.addEventListener("change", async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const data=JSON.parse(await f.text());
    if(Array.isArray(data.tasks)){ state.tasks=data.tasks; save(); renderTasks(); renderCalendar(); showToast("✅ Pulizie importate"); }
    else alert("File non valido (manca 'tasks').");
  }catch(err){ alert("Import non riuscito: "+err); }
  e.target.value="";
});
exportMyScoreBtn.addEventListener("click", ()=>{
  const uid=state.activeUserId, name = (state.users.find(u=>u.id===uid)||{}).name || "utente";
  const payload = JSON.stringify({userId: uid, userName: name, score: state.score[uid]||0, history: state.history.filter(h=>h.userId===uid)}, null, 2);
  const file=new File([payload],`classifica-${name.replace(/\s+/g,'_')}.json`,{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(file); a.download=file.name; a.click(); URL.revokeObjectURL(a.href);
  showToast("⬇️ Esportata classifica utente attivo");
});
importMyScoreInput.addEventListener("change", async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const data=JSON.parse(await f.text());
    const uid=state.activeUserId;
    if(typeof data.score==="number"){
      state.score[uid]=data.score;
      if(Array.isArray(data.history)){ state.history = state.history.concat(data.history.map(h=>({...h, userId:uid, userName:(state.users.find(u=>u.id===uid)||{}).name||h.userName, reason:(h.reason||"import")+" (import)"}))); }
      save(); renderLeader(); renderHistory(); showToast("✅ Classifica aggiornata (utente attivo)");
    }else{
      alert("File non valido (manca 'score').");
    }
  }catch(err){ alert("Import non riuscito: "+err); }
  e.target.value="";
});

/* Backup completo */
byId("backup").addEventListener("click", ()=>{ const payload=JSON.stringify(state,null,2); const file=new File([payload],"pulizie-backup-"+todayYMD()+".json",{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(file); a.download=file.name; a.click(); URL.revokeObjectURL(a.href); showToast("💾 Backup completo creato"); });
const restoreFile = document.getElementById("restoreFile");
restoreFile.addEventListener("change", async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  try{
    state = migrate(JSON.parse(await f.text()));
    save(); boot(); showToast("🧰 Ripristino completo");
  }catch(err){
    alert("Ripristino non riuscito: " + err);
  }finally{
    e.target.value = "";
  }
});
byId("clearDone").addEventListener("click", ()=>{ state.tasks=state.tasks.filter(t=>!t.done); save(); renderTasks(); renderCalendar(); showToast("🧹 Completate cancellate"); });

/* ===== Navigazione Menù ===== */
const viewTasks=byId("viewTasks"), viewCalendar=byId("viewCalendar"), viewRank=byId("viewRank"), viewSettings=byId("viewSettings");
let currentTab="tasks";
const navTabs=document.querySelectorAll('.nav-tab');

function updateNav(tab){
  navTabs.forEach(b=>{
    const active=b.dataset.tab===tab;
    b.classList.toggle('active',active);
    b.setAttribute('aria-selected',active);
    b.setAttribute('tabindex',active?'0':'-1');
  });
}

updateNav(currentTab);

function switchView(tab){
  [viewTasks,viewCalendar,viewRank,viewSettings].forEach(v=>v.classList.remove('active'));
  if(tab==='tasks'){ viewTasks.classList.add('active'); byId('appTitle').textContent='Pulizie di Casa'; }
  if(tab==='calendar'){ viewCalendar.classList.add('active'); byId('appTitle').textContent='Calendario Pulizie'; renderCalendar(); }
  if(tab==='rank'){ viewRank.classList.add('active'); byId('appTitle').textContent='Classifica'; renderLeader(); renderHistory(); }
  if(tab==='settings'){ viewSettings.classList.add('active'); byId('appTitle').textContent='Impostazioni'; }
  currentTab = tab;
  updateNav(tab);
  updateNavOffset();
  window.scrollTo({top:0,behavior:'smooth'});
}

navTabs.forEach(b=> b.addEventListener('click', ()=> switchView(b.dataset.tab)));

document.getElementById('mainNav').addEventListener('keydown', e=>{
  if(!e.target.classList.contains('nav-tab')) return;
  const tabs=Array.from(navTabs);
  let idx=tabs.indexOf(e.target);
  if(e.key==='ArrowRight'){ idx=(idx+1)%tabs.length; tabs[idx].focus(); e.preventDefault(); }
  else if(e.key==='ArrowLeft'){ idx=(idx-1+tabs.length)%tabs.length; tabs[idx].focus(); e.preventDefault(); }
  else if(e.key==='Enter' || e.key===' '){ e.preventDefault(); e.target.click(); }
});

function updateNavOffset(){
  const h=document.getElementById('appHeader').offsetHeight;
  document.documentElement.style.setProperty('--nav-height', h+'px');
}
window.addEventListener('resize', updateNavOffset);
updateNavOffset();

/* ===== Calendario ===== */
const calGrid=byId("calGrid"), calTitle=byId("calTitle");
const calPrev=byId("calPrev"), calNext=byId("calNext"), calToday=byId("calToday"), calAdd=byId("calAdd");
const dayDrawer=byId("dayDrawer"), dayScrim=byId("dayScrim"), dayTitle=byId("dayTitle"), dayList=byId("dayList"), dayAddBtn=byId("dayAddBtn");
let selectedCell=null;

let calRef = new Date();
function setCalTo(year, month){ calRef = new Date(year, month, 1); }
function monthLabel(d){ return d.toLocaleDateString('it-IT', { month:'long', year:'numeric' }); }
function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }

function renderCalendar(){
  calTitle.textContent = monthLabel(calRef).replace(/^\w/, c=>c.toUpperCase());
  closeDayDrawer();
  const y = calRef.getFullYear(), m = calRef.getMonth();
  const firstDow = new Date(y, m, 1).getDay();
  const startOffset = (firstDow+6)%7;
  const totalDays = daysInMonth(y,m);
  const prevMonthDays = daysInMonth(y, m-1);

  const labels = ["Lun","Mar","Mer","Gio","Ven","Sab","Dom"];
  calGrid.innerHTML = labels.map(w=>`<div class="cal-dow">${w}</div>`).join("");

  const cells = [];
  for(let i=0;i<42;i++){
    const dayNum = i - startOffset + 1;
    let d, muted=false;
    if(dayNum < 1){ const n = prevMonthDays + dayNum; d = new Date(y, m-1, n); muted = true; }
    else if(dayNum > totalDays){ const n = dayNum - totalDays; d = new Date(y, m+1, n); muted = true; }
    else { d = new Date(y, m, dayNum); }

    const count = state.tasks.filter(t=>{
      if(t.done) return false;
      return occursOnDay(t, d);
    }).length;

    const cell=document.createElement("div");
    cell.className="cal-cell"+(muted?" muted":"");
    if(!muted && isSameDay(d,new Date())) cell.classList.add("today");
    cell.setAttribute("data-date", d.toISOString().slice(0,10));
    cell.innerHTML = `<div class="cal-daynum">${d.getDate()}</div>${count? `<div class="cal-badge" aria-label="${count} pulizie">${count}</div>`:""}`;
    cell.addEventListener("click", ()=> openDayDrawer(d, cell));
    cells.push(cell);
  }
  cells.forEach(c=>calGrid.appendChild(c));

  selectedCell=null;
}
function openDayDrawer(d, cell){
  const items = state.tasks.filter(t=> occursOnDay(t,d));
  dayTitle.textContent = d.toLocaleDateString('it-IT', { weekday:'long', day:'2-digit', month:'2-digit' });
  if(items.length){
    const list = items.sort((a,b)=> (a.priority-b.priority) || (a.title||"").localeCompare(b.title||""))
      .map(t=>{
        const desc = t.notes ? ` • ${esc(t.notes)}` : "";
        const hasPhotos = t.photo ? ' • 📷1' : '';
        return `<li class="task future" style="list-style:none; margin:8px 0; padding:10px; border-radius:10px; border:1px solid var(--border-color);">
  <div style="display:flex; gap:8px; align-items:center;">
    <div class="head-main" style="flex:1; min-width:0;">
      <div class="title">${esc(t.title||t.name)}</div>
      <div class="notes-line">${desc}${hasPhotos}</div>
    </div>
    <button class="btn" data-edit="${t.id}">Modifica</button>
  </div>
</li>`;
      }).join("");
    dayList.innerHTML = `<ul style="padding:0;margin:6px 0 0 0; list-style:none;">${list}</ul>`;
    dayList.querySelectorAll('button[data-edit]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const t = state.tasks.find(x=>x.id===b.getAttribute('data-edit'));
        if(t){ closeDayDrawer(); openEditor(t); }
      });
    });
  }else{
    dayList.innerHTML = `<div class="cal-empty">Nessuna pulizia prevista</div>`;
  }
  if(selectedCell) selectedCell.classList.remove('selected');
  selectedCell = cell;
  cell.classList.add('selected');
  dayDrawer.classList.add('open');
  dayDrawer.setAttribute('aria-hidden','false');
  trapFocus(dayDrawer.querySelector('.panel'));
}
function closeDayDrawer(){
  dayDrawer.classList.remove('open');
  dayDrawer.setAttribute('aria-hidden','true');
  if(selectedCell) selectedCell.classList.remove('selected');
  releaseFocus();
}
dayScrim.addEventListener('click', closeDayDrawer);
dayAddBtn.addEventListener('click', ()=>{ closeDayDrawer(); openEditor(); });
document.addEventListener('keydown', e=>{ if(e.key==='Escape' && dayDrawer.classList.contains('open')) closeDayDrawer(); });
calPrev.addEventListener("click", ()=>{ setCalTo(calRef.getFullYear(), calRef.getMonth()-1); renderCalendar(); });
calNext.addEventListener("click", ()=>{ setCalTo(calRef.getFullYear(), calRef.getMonth()+1); renderCalendar(); });
calToday.addEventListener("click", ()=>{ const n=new Date(); setCalTo(n.getFullYear(), n.getMonth()); renderCalendar(); });
calAdd.addEventListener("click", ()=> openEditor());
addTaskBtn.addEventListener("click", ()=> openEditor());

/* ===== Accordion: un solo menù aperto ===== */
const acc = document.getElementById("settingsAccordion");
if(acc){
  acc.querySelectorAll("details").forEach((d,i)=>{
    const s = d.querySelector("summary");
    const pid = `settings-panel-${i}`;
    d.setAttribute('role','region');
    d.id = pid;
    s.setAttribute('role','button');
    s.setAttribute('aria-controls', pid);
    s.setAttribute('aria-expanded', d.open);
    d.addEventListener("toggle", ()=>{
      s.setAttribute('aria-expanded', d.open);
      if(d.open){
        acc.querySelectorAll("details").forEach(o=>{ if(o!==d){ o.open=false; const so=o.querySelector('summary'); so.setAttribute('aria-expanded', o.open); } });
      }
    });
  });
}

/* ===== Boot ===== */
function boot(){
  applyPalette(state.appearance.palette||APP_PALETTES[3]);
  applyTheme(state.appearance.theme||"system");
  themeSelect.value = state.appearance.theme||"system";
  renderHeader();
  renderRoomSelect(); renderAssigneeSelects();
  renderUsersList(); renderRooms();
  renderAppPalettes();
  renderRoomFilters(); renderChips();
  renderTasks(); renderLeader(); renderHistory();
  applyDailyMalus();
  const n=new Date(); setCalTo(n.getFullYear(), n.getMonth());

  updateTextContrast();

}
boot();
</script>
<script type="module" src="main.js?v=1"></script>
</body>
</html>
