<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Pulizie di Casa</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#007AFF">

  <style>
    :root{
      --brand:#007AFF;
      --accent-me:#2563eb;
      --accent-partner:#e11d48;
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f1222;
      --muted:#616b7f;
      --ok:#2ecc71;
      --warn:#ffb020;
      --danger:#ff5e57;
      --border:#e6e8f0;
      --shadow:0 10px 24px rgba(0,0,0,.08);
      --radius:16px;
      --fs-1:18px; --fs-2:16px; --fs-3:14px;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0f1115; --card:#151923; --text:#eef1f6; --muted:#9aa3b2; --border:#232838; --shadow:0 10px 24px rgba(0,0,0,.35); }
    }
    .dark{ --bg:#0f1115; --card:#151923; --text:#eef1f6; --muted:#9aa3b2; --border:#232838; --shadow:0 10px 24px rgba(0,0,0,.35); }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial}
    body{
      background:var(--bg);color:var(--text);line-height:1.45;
      padding-bottom:calc(56px + var(--safe-bottom));
      overflow-x:hidden; /* blocca lo scroll orizzontale */
    }

    /* Header */
    header{
      position:sticky; top:0; z-index:20;
      background:var(--card); box-shadow:var(--shadow);
      padding:calc(10px + var(--safe-top)) 12px 10px 12px;
      display:flex; align-items:center; gap:10px;
    }
    header h1{font-size:var(--fs-1); margin:0; flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .pill{font-size:12px; padding:6px 10px; border-radius:999px; background:#eef5ff; color:var(--brand); display:flex; align-items:center; gap:8px; border:1px solid var(--border)}
    .avatar{width:18px; height:18px; border-radius:50%; border:2px solid rgba(255,255,255,.5);}
    .icon-btn{ appearance:none; border:1px solid var(--border); background:transparent; border-radius:12px; padding:10px; display:inline-flex; align-items:center; justify-content:center; }
    .icon{ width:20px; height:20px; display:inline-block; }

    /* Tabs */
    nav.tabs{
      position:sticky; top:calc(56px + var(--safe-top)); z-index:19;
      display:flex; gap:6px; padding:10px 12px; background:var(--bg); border-bottom:1px solid var(--border);
    }
    nav.tabs button{
      flex:1; padding:10px 12px; border:1px solid var(--border); border-radius:999px;
      background:var(--card); color:var(--muted); font-weight:700; font-size:var(--fs-2);
    }
    nav.tabs button.active{ color:var(--brand); border-color:var(--brand); }

    /* List container */
    .container{max-width:820px; margin:0 auto; padding:12px;}
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);}

    /* List */
    ul#list{ list-style:none; padding:0; margin:0; }
    li.task{ display:flex; gap:12px; padding:14px; border-bottom:1px solid var(--border); align-items:flex-start; }
    li.task:last-child{ border-bottom:0; }
    .chk input{ width:26px; height:26px; }
    .task-main{ flex:1; min-width:0; } /* evita overflow orizzontale */
    .title{ font-weight:800; font-size:var(--fs-2); word-break:break-word; }
    .meta{ color:var(--muted); font-size:var(--fs-3); margin-top:6px; display:flex; flex-wrap:wrap; gap:8px }
    .badges{ display:flex; flex-wrap:wrap; gap:6px; }
    .badges span{ font-size:11px; background:#f1f3f9; border:1px solid var(--border); padding:4px 8px; border-radius:999px; white-space:nowrap; }
    .assignee-me{background: rgba(37,99,235,.12)!important; color:#cbdafe!important; border-color: rgba(37,99,235,.35)!important}
    .assignee-partner{background: rgba(225,29,72,.12)!important; color:#fecdd3!important; border-color: rgba(225,29,72,.35)!important}
    .overdue{ color:var(--danger); font-weight:700;}
    .due-soon{ color:var(--warn); font-weight:700;}
    .done .title{ text-decoration:line-through; color:#9aa3b2}
    .actions{ display:flex; gap:8px; flex-wrap:wrap }
    .btn{ padding:10px 12px; border:1px solid var(--border); background:transparent; border-radius:12px; color:var(--text); }

    .empty{ padding:24px; text-align:center; color:var(--muted); font-size:var(--fs-2) }

    /* FAB */
    .fab{
      position:fixed; right:16px; bottom:calc(16px + var(--safe-bottom));
      width:56px; height:56px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      background:var(--brand); color:#fff; font-size:28px; font-weight:700;
      border:none; box-shadow:0 14px 30px rgba(0,0,0,.2); z-index:30;
    }

    /* Modals (vertical-only) */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:40;
    }
    .modal{
      position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
      width:min(680px,96vw); max-height:85vh; display:none; z-index:41;
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
      overflow:hidden; /* niente scroll laterale */
    }
    .modal header{ position:sticky; top:0; box-shadow:none; padding:12px 16px; display:flex; align-items:center; gap:10px; }
    .modal header h2{ margin:0; font-size:18px; flex:1; }
    .modal .content{
      padding:12px 16px 18px 16px;
      overflow-y:auto; /* solo verticale */
      overscroll-behavior:contain;
      max-width:100%;
    }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .grid-1{ grid-template-columns:1fr; }
    .grid .full{ grid-column:1/-1; }
    .field, .field > *{ width:100%; }
    input, select, textarea{ padding:12px; border:1px solid var(--border); border-radius:12px; background:transparent; color:var(--text); font-size:var(--fs-2); }
    textarea{ min-height:80px; resize:vertical }
    .modal footer{ padding:12px 16px 14px; display:flex; gap:10px; justify-content:flex-end; }
    .btn.primary{ background:var(--brand); color:#fff; border-color:var(--brand); font-weight:700; }

    /* Toggle/switch visibili */
    .switch{ display:inline-flex; align-items:center; gap:10px; font-size:var(--fs-2); }
    .switch input[type="checkbox"]{ appearance:none; width:46px; height:28px; background:#c9d3e6; border-radius:999px; position:relative; outline:none; border:1px solid var(--border); transition:.2s; }
    .switch input[type="checkbox"]::after{
      content:""; position:absolute; top:2px; left:2px; width:24px; height:24px; border-radius:50%; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,.15); transition:.2s;
    }
    .switch input[type="checkbox"]:checked{ background:var(--brand); }
    .switch input[type="checkbox"]:checked::after{ left:20px; }

    /* Select: no horizontal scroll su iOS */
    select{ max-width:100%; overflow-x:hidden; }

    @media (max-width:600px){
      .grid{ grid-template-columns:1fr; }
      .actions{ gap:6px }
      .btn{ padding:8px 10px }
    }
  </style>
</head>
<body>
  <header>
    <h1>üßπ Pulizie di Casa</h1>
    <span class="pill" id="who-pill" title="Utente attivo">
      <span class="avatar" id="avatar"></span>
      <strong id="who"></strong>
    </span>
    <!-- Gear (Impostazioni) -->
    <button id="openSettings" class="icon-btn" aria-label="Impostazioni" title="Impostazioni">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-width="2" d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/>
        <path stroke-width="2" d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 1 1 7.04 3.3l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06A2 2 0 1 1 21.7 7.04l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .67.39 1.28 1.01 1.51.22.09.46.14.7.14a2 2 0 1 1 0 4h-.09c-.67 0-1.28.39-1.51 1Z"/>
      </svg>
    </button>
  </header>

  <!-- Sticky tabs -->
  <nav class="tabs">
    <button data-tab="oggi" class="active">Oggi</button>
    <button data-tab="tutte">Tutte</button>
    <button data-tab="fatte">Completate</button>
  </nav>

  <div class="container card" id="view">
    <ul id="list"></ul>
    <div class="empty" id="empty" style="display:none">Niente da mostrare üßΩ</div>
  </div>

  <!-- FAB Add -->
  <button class="fab" id="fabAdd" aria-label="Aggiungi">+</button>

  <!-- SETTINGS MODAL -->
  <div id="backdropSettings" class="modal-backdrop"></div>
  <section id="modalSettings" class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <header>
      <h2 id="settingsTitle">Impostazioni</h2>
      <!-- X in alto a destra -->
      <button id="closeSettings" class="icon-btn" aria-label="Chiudi">
        <svg class="icon" viewBox="0 0 24 24" stroke="currentColor" fill="none">
          <path stroke-width="2" d="M6 6l12 12M18 6l-12 12"/>
        </svg>
      </button>
    </header>
    <div class="content">
      <!-- Accordion per categorie -->
      <details open>
        <summary><strong>Utenti</strong></summary>
        <div class="grid" style="margin-top:10px">
          <input id="me" class="field" placeholder="Il tuo nome (es. Alberto)">
          <input id="partner" class="field" placeholder="Nome partner (es. Giorgia)">
          <button id="swapUser" class="btn">Cambia utente attivo</button>
        </div>
      </details>

      <details>
        <summary><strong>Visualizzazione</strong></summary>
        <div class="grid" style="margin-top:10px">
          <label class="field">Colore primario <input id="colorPrimary" type="color" value="#007AFF"></label>
          <label class="field">Colore secondario <input id="colorSecondary" type="color" value="#e11d48"></label>
          <button id="toggleTheme" class="btn">Toggle tema scuro</button>
        </div>
      </details>

      <details>
        <summary><strong>Notifiche &amp; Promemoria</strong></summary>
        <div class="grid" style="margin-top:10px">
          <label class="field full">Ora promemoria (HH:MM)
            <input id="remindAt" placeholder="09:00" value="09:00">
          </label>
          <label class="switch"><input type="checkbox" id="resurfaceUnfinished"> Riproponi non completate ogni giorno</label>
          <button id="enableNotifs" class="btn">Abilita notifiche</button>
        </div>
      </details>

      <details>
        <summary><strong>Dati &amp; Backup</strong></summary>
        <div class="grid" style="margin-top:10px">
          <button id="export" class="btn">Esporta JSON</button>
          <input type="file" id="import" accept="application/json" class="btn">
          <button id="backup" class="btn">Backup</button>
          <button id="restore" class="btn">Ripristina backup</button>
          <button id="clearDone" class="btn">Cancella completate</button>
        </div>
      </details>

      <details>
        <summary><strong>Avanzate</strong></summary>
        <div class="grid" style="margin-top:10px">
          <small class="muted">Le impostazioni avanzate potrebbero cambiare in futuro.</small>
        </div>
      </details>

      <small class="muted">I dati restano solo su questo dispositivo.</small>
    </div>
  </section>

  <!-- ADD TASK MODAL -->
  <div id="backdropAdd" class="modal-backdrop"></div>
  <section id="modalAdd" class="modal" role="dialog" aria-modal="true" aria-labelledby="addTitle">
    <header>
      <h2 id="addTitle">Nuovo compito</h2>
    </header>
    <div class="content">
      <form id="newTask" class="grid">
        <input id="title" class="field full" placeholder="Attivit√† (es. Passare l'aspirapolvere)" required>
        <select id="room" class="field"><option value="">Stanza</option><option>Cucina</option><option>Soggiorno</option><option>Bagno</option><option>Camera</option><option>Ingresso</option><option>Balcone</option><option>Altro</option></select>
        <select id="priority" class="field"><option value="2">Priorit√† media</option><option value="1">Priorit√† alta</option><option value="3">Priorit√† bassa</option></select>
        <label class="field full">Inizio (giorno e ora)
          <input id="startAt" type="datetime-local" placeholder="YYYY-MM-DD hh:mm">
        </label>
        <label class="switch field full"><input type="checkbox" id="isRepeating"> Ripetitivo (calendario fisso)</label>
        <div id="repeatBar" class="grid full" style="display:none; grid-template-columns:1fr 1fr; gap:10px;">
          <input id="repeatEvery" class="field" type="number" min="1" step="1" value="1" aria-label="Ogni">
          <select id="repeatUnit" class="field" aria-label="Unit√†"><option value="days">giorni</option><option value="weeks">settimane</option><option value="months">mesi</option></select>
        </div>
        <textarea id="notes" class="field full" placeholder="Note (opzionale)"></textarea>
        <input id="assignee" class="field" placeholder="Assegnata a (es. Alberto, Giorgia)">
      </form>
    </div>
    <footer>
      <button id="cancelAdd" class="btn">Annulla</button>
      <button form="newTask" type="submit" class="btn primary">Aggiungi</button>
    </footer>
  </section>

  <!-- EDIT TASK MODAL -->
  <div id="backdropEdit" class="modal-backdrop"></div>
  <section id="modalEdit" class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <header>
      <h2 id="editTitle">Modifica compito</h2>
      <button id="cancelEdit" class="icon-btn" aria-label="Chiudi">
        <svg class="icon" viewBox="0 0 24 24" stroke="currentColor" fill="none">
          <path stroke-width="2" d="M6 6l12 12M18 6l-12 12"/>
        </svg>
      </button>
    </header>
    <div class="content">
      <form id="editTaskForm" class="grid">
        <input id="e-title" class="field full" placeholder="Attivit√†" required>
        <select id="e-room" class="field">
          <option value="">Stanza</option><option>Cucina</option><option>Soggiorno</option>
          <option>Bagno</option><option>Camera</option><option>Ingresso</option><option>Balcone</option><option>Altro</option>
        </select>
        <select id="e-priority" class="field">
          <option value="2">Priorit√† media</option><option value="1">Priorit√† alta</option><option value="3">Priorit√† bassa</option>
        </select>
        <label class="field full">Inizio (giorno e ora)
          <input id="e-startAt" type="datetime-local" placeholder="YYYY-MM-DD hh:mm">
        </label>
        <label class="switch field full">
          <input type="checkbox" id="e-isRepeating"> Ripetitivo (calendario fisso)
        </label>
        <div id="e-repeatBar" class="grid full" style="display:none; grid-template-columns:1fr 1fr; gap:10px;">
          <input id="e-repeatEvery" class="field" type="number" min="1" step="1" value="1" aria-label="Ogni">
          <select id="e-repeatUnit" class="field" aria-label="Unit√†">
            <option value="days">giorni</option><option value="weeks">settimane</option><option value="months">mesi</option>
          </select>
        </div>
        <textarea id="e-notes" class="field full" placeholder="Note (opzionale)"></textarea>
        <input id="e-assignee" class="field" placeholder="Assegnata a (es. Alberto, Giorgia)">
      </form>
    </div>
    <footer>
      <button form="editTaskForm" type="submit" class="btn primary">Salva</button>
    </footer>
  </section>

  <script>
    /* === Versioni / dati === */
    const DBKEY = "pulizie-db-v3"; // schema invariato
    const nowISO = () => new Date().toISOString();
    const todayYMD = () => new Date().toISOString().slice(0,10);

    const defaults = {
      version: 3,
      tasks: [],
      users: { me:"Alberto", partner:"Giorgia" },
      active: "me",
      history: [],
      settings: { remindAt:"09:00", theme:"auto", colorPrimary:"#007AFF", colorSecondary:"#e11d48", resurfaceUnfinished:false },
      notified: {}
    };

    function loadDb(){
      const raw = localStorage.getItem(DBKEY);
      if(raw){
        const d = JSON.parse(raw);
        return { ...defaults, ...d, settings:{...defaults.settings, ...(d.settings||{})} };
      }
      localStorage.setItem(DBKEY, JSON.stringify(defaults));
      return structuredClone(defaults);
    }
    let state = loadDb();
    const save = ()=> localStorage.setItem(DBKEY, JSON.stringify(state));

    /* SW */
    if("serviceWorker" in navigator){ addEventListener("load", ()=> navigator.serviceWorker.register("./service-worker.js").catch(()=>{}) ); }

    /* Elements */
    const whoEl = document.getElementById("who");
    const avatarEl = document.getElementById("avatar");
    const whoPill = document.getElementById("who-pill");
    const listEl = document.getElementById("list");
    const emptyEl = document.getElementById("empty");

    /* Tabs */
    let tab = "oggi";
    document.querySelectorAll("nav.tabs button").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll("nav.tabs button").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        tab = btn.dataset.tab;
        render();
      });
    });

    /* Theme & colors */
    function applyTheme(){
      document.documentElement.classList.toggle("dark", state.settings.theme==="dark");
      document.documentElement.style.setProperty("--brand", state.settings.colorPrimary||"#007AFF");
      document.documentElement.style.setProperty("--accent-partner", state.settings.colorSecondary||"#e11d48");
    }
    applyTheme();

    /* Pill utente */
    function renderPill(){
      const name = state.active==="me" ? state.users.me : state.users.partner;
      whoEl.textContent = name || (state.active==="me" ? "Alberto":"Giorgia");
      whoPill.title = "Utente attivo: " + whoEl.textContent;
      const color = state.active==="me"
        ? getComputedStyle(document.documentElement).getPropertyValue("--accent-me")
        : getComputedStyle(document.documentElement).getPropertyValue("--accent-partner");
      avatarEl.style.background = color.trim();
    }

    /* Scheduling helpers */
    function parseLocal(dt){ return dt ? new Date(dt) : null; }
    function addInterval(d,n,u){ const nd=new Date(d); if(u==="days") nd.setDate(nd.getDate()+n); else if(u==="weeks") nd.setDate(nd.getDate()+7*n); else nd.setMonth(nd.getMonth()+n); return nd; }
    function nextOccurrenceFromStart(start,every,unit,ref){
      if(!start) return null;
      let cur = new Date(start);
      if(!every||every<1) return cur;
      if(cur>=ref) return cur;
      let guard=0; while(cur<ref&&guard++<800){ cur = addInterval(cur,every,unit); }
      return cur;
    }
    function isSameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
    function statusForTask(t){
      const now = new Date();
      const start = parseLocal(t.startAt);
      if(!start) return {next:null, overdue:false, dueSoon:false, today:false};
      const next = t.repeat?.enabled ? nextOccurrenceFromStart(start, t.repeat.every, t.repeat.unit, now) : start;
      const overdue = next < now && !isSameDay(next, now);
      const dueSoon = isSameDay(next, now);
      const today = dueSoon;
      return { next, overdue, dueSoon, today };
    }
    function humanNext(s){
      if(!s.next) return "";
      const y=s.next.getFullYear(), m=String(s.next.getMonth()+1).padStart(2,"0"), d=String(s.next.getDate()).padStart(2,"0");
      const hh=String(s.next.getHours()).padStart(2,"0"), mm=String(s.next.getMinutes()).padStart(2,"0");
      return `${y}-${m}-${d} ${hh}:${mm}`;
    }

    function getFiltered(which){
      const tasks=[...state.tasks];
      tasks.sort((a,b)=>{
        const sa=statusForTask(a).next||new Date("9999-12-31");
        const sb=statusForTask(b).next||new Date("9999-12-31");
        return (a.done-b.done)||(a.priority-b.priority)||(sa-sb);
      });
      if(which==="oggi"){
        const todayStart=new Date(todayYMD()+"T00:00:00");
        return tasks.filter(t=>{
          if(t.done) return false;
          const s=statusForTask(t);
          if(s.today) return true;
          if(state.settings.resurfaceUnfinished){
            const start=parseLocal(t.startAt);
            if(!start) return false;
            if(t.repeat?.enabled){
              const prev=nextOccurrenceFromStart(start, t.repeat.every, t.repeat.unit, new Date(todayStart - 1));
              if(prev && prev < todayStart) return true;
            } else if(start < todayStart){ return true; }
          }
          return false;
        });
      }
      if(which==="fatte") return tasks.filter(t=>t.done);
      return tasks;
    }

    function render(){
      renderPill();
      listEl.innerHTML=""; emptyEl.style.display="none";
      const tasks=getFiltered(tab);
      if(!tasks.length){ emptyEl.style.display="block"; return; }

      for(const t of tasks){
        const li=document.createElement("li"); li.className="task"+(t.done?" done":""); li.dataset.id=t.id;

        const chk=document.createElement("div"); chk.className="chk";
        const input=document.createElement("input"); input.type="checkbox"; input.checked=!!t.done;
        input.addEventListener("change", ()=>{ t.done=input.checked; if(t.done){ t.lastDone=nowISO(); (state.history ||= []).push({k:t.id+"@"+t.lastDone,id:t.id,when:t.lastDone,who:state.active}); } save(); render(); });
        chk.appendChild(input); li.appendChild(chk);

        const main=document.createElement("div"); main.className="task-main";
        const title=document.createElement("div"); title.className="title"; title.textContent=t.title; main.appendChild(title);

        const meta=document.createElement("div"); meta.className="meta";
        const b=document.createElement("div"); b.className="badges";
        const tags=[];
        if(t.room) tags.push(t.room);
        tags.push(t.priority===1?"Alta":t.priority===2?"Media":"Bassa");
        if(t.assignee){
          const who=t.assignee.trim().toLowerCase();
          const cls=(who===(state.users.me||"").trim().toLowerCase())?"assignee-me":(who===(state.users.partner||"").trim().toLowerCase())?"assignee-partner":"";
          tags.push(`<span class="${cls}">A: ${t.assignee}</span>`);
        }
        if(t.repeat?.enabled) tags.push(`Ogni ${t.repeat.every} ${t.repeat.unit==="days"?"giorni":t.repeat.unit==="weeks"?"settimane":"mesi"}`);
        else tags.push("Singolo");
        b.innerHTML=tags.map(s=>s.startsWith("<span")?s:`<span>${s}</span>`).join(" ");
        meta.appendChild(b);

        const s=statusForTask(t);
        if(s.next){
          const sts=s.overdue?"overdue":s.dueSoon?"due-soon":"";
          const due=document.createElement("div"); due.innerHTML=`Prossima: <strong class="${sts}">${humanNext(s)}</strong>`;
          meta.appendChild(due);
        }
        if(t.notes){ const notes=document.createElement("div"); notes.textContent=t.notes; meta.appendChild(notes); }

        main.appendChild(meta); li.appendChild(main);

        const actions=document.createElement("div"); actions.className="actions";
        const editBtn=document.createElement("button"); editBtn.className="btn"; editBtn.textContent="Modifica"; editBtn.addEventListener("click", ()=> editTask(t)); actions.appendChild(editBtn);
        const delBtn=document.createElement("button"); delBtn.className="btn"; delBtn.textContent="Elimina"; delBtn.addEventListener("click", ()=>{ if(confirm("Eliminare questa attivit√†?")){ state.tasks=state.tasks.filter(x=>x.id!==t.id); save(); render(); } }); actions.appendChild(delBtn);
        li.appendChild(actions);

        listEl.appendChild(li);
      }
    }

    /* ======= SETTINGS MODAL ======= */
    const modalSettings=document.getElementById("modalSettings");
    const backdropSettings=document.getElementById("backdropSettings");
    const openSettingsBtn=document.getElementById("openSettings");
    const closeSettingsBtn=document.getElementById("closeSettings");
    function openSettings(){ backdropSettings.style.display="block"; modalSettings.style.display="block"; }
    function closeSettings(){ backdropSettings.style.display="none"; modalSettings.style.display="none"; }
    openSettingsBtn.addEventListener("click", openSettings);
    closeSettingsBtn.addEventListener("click", closeSettings);
    backdropSettings.addEventListener("click", closeSettings);

    /* ======= ADD MODAL ======= */
    const modalAdd=document.getElementById("modalAdd");
    const backdropAdd=document.getElementById("backdropAdd");
    const fabAdd=document.getElementById("fabAdd");
    const cancelAdd=document.getElementById("cancelAdd");
    function openAdd(){ backdropAdd.style.display="block"; modalAdd.style.display="block"; }
    function closeAdd(){ backdropAdd.style.display="none"; modalAdd.style.display="none"; }
    fabAdd.addEventListener("click", openAdd);
    cancelAdd.addEventListener("click", closeAdd);
    backdropAdd.addEventListener("click", closeAdd);

    // New task form
    const newTaskForm=document.getElementById("newTask");
    const isRepeatingEl=document.getElementById("isRepeating");
    const repeatBar=document.getElementById("repeatBar");
    const repeatEveryEl=document.getElementById("repeatEvery");
    const repeatUnitEl=document.getElementById("repeatUnit");
    isRepeatingEl.addEventListener("change", ()=>{ repeatBar.style.display=isRepeatingEl.checked?"grid":"none"; });
    newTaskForm.addEventListener("submit", (e)=>{
      e.preventDefault();
      const title=document.getElementById("title").value.trim(); if(!title) return;
      const t={
        id:crypto.randomUUID(), title,
        room:document.getElementById("room").value.trim(),
        priority:parseInt(document.getElementById("priority").value,10),
        assignee:document.getElementById("assignee").value.trim(),
        startAt:document.getElementById("startAt").value||null,
        repeat:{ enabled:isRepeatingEl.checked, every:parseInt(repeatEveryEl.value||"1",10), unit:repeatUnitEl.value },
        notes:document.getElementById("notes").value.trim(),
        createdAt:nowISO(), lastDone:null, done:false
      };
      state.tasks.push(t); save();
      newTaskForm.reset(); repeatBar.style.display="none"; closeAdd();
      render(); scheduleCheckSoon();
    });

    /* ======= EDIT MODAL ======= */
    const modalEdit = document.getElementById("modalEdit");
    const backdropEdit = document.getElementById("backdropEdit");
    const cancelEdit = document.getElementById("cancelEdit");
    const editForm = document.getElementById("editTaskForm");

    const eTitle = document.getElementById("e-title");
    const eRoom = document.getElementById("e-room");
    const ePriority = document.getElementById("e-priority");
    const eStartAt = document.getElementById("e-startAt");
    const eIsRepeating = document.getElementById("e-isRepeating");
    const eRepeatBar = document.getElementById("e-repeatBar");
    const eRepeatEvery = document.getElementById("e-repeatEvery");
    const eRepeatUnit = document.getElementById("e-repeatUnit");
    const eNotes = document.getElementById("e-notes");
    const eAssignee = document.getElementById("e-assignee");

    let currentEditId = null;

    function openEdit(task){
      currentEditId = task.id;
      eTitle.value = task.title || "";
      eRoom.value = task.room || "";
      ePriority.value = String(task.priority || 2);
      eStartAt.value = task.startAt || "";
      const rep = task.repeat || {enabled:false, every:1, unit:"days"};
      eIsRepeating.checked = !!rep.enabled;
      eRepeatEvery.value = rep.every || 1;
      eRepeatUnit.value = rep.unit || "days";
      eRepeatBar.style.display = eIsRepeating.checked ? "grid" : "none";
      eNotes.value = task.notes || "";
      eAssignee.value = task.assignee || "";

      backdropEdit.style.display = "block";
      modalEdit.style.display = "block";
    }
    function closeEdit(){
      backdropEdit.style.display = "none";
      modalEdit.style.display = "none";
      currentEditId = null;
    }
    eIsRepeating.addEventListener("change", ()=>{ eRepeatBar.style.display = eIsRepeating.checked ? "grid" : "none"; });
    cancelEdit.addEventListener("click", closeEdit);
    backdropEdit.addEventListener("click", closeEdit);

    editForm.addEventListener("submit", (e)=>{
      e.preventDefault();
      if(!currentEditId) return closeEdit();
      const idx = state.tasks.findIndex(t => t.id === currentEditId);
      if(idx === -1) return closeEdit();

      const t = state.tasks[idx];
      t.title = eTitle.value.trim() || t.title;
      t.room = eRoom.value.trim();
      t.priority = Math.min(3, Math.max(1, parseInt(ePriority.value||"2",10) || 2));
      t.startAt = (eStartAt.value||"").trim() || null;
      t.repeat = {
        enabled: eIsRepeating.checked,
        every: Math.max(1, parseInt(eRepeatEvery.value||"1",10) || 1),
        unit: eRepeatUnit.value
      };
      t.notes = eNotes.value.trim();
      t.assignee = eAssignee.value.trim();

      save();
      closeEdit();
      render();
      scheduleCheckSoon();
    });

    // questa funzione √® chiamata dal bottone "Modifica" nelle card
    function editTask(t){ openEdit(t); }

    /* ======= Settings binding ======= */
    const meInput=document.getElementById("me");
    const partnerInput=document.getElementById("partner");
    const swapBtn=document.getElementById("swapUser");
    const remindAtInput=document.getElementById("remindAt");
    const enableNotifsBtn=document.getElementById("enableNotifs");
    const colorPrimary=document.getElementById("colorPrimary");
    const colorSecondary=document.getElementById("colorSecondary");
    const resurfaceChk=document.getElementById("resurfaceUnfinished");
    const exportBtn=document.getElementById("export");
    const importInput=document.getElementById("import");
    const backupBtn=document.getElementById("backup");
    const restoreBtn=document.getElementById("restore");
    const clearDoneBtn=document.getElementById("clearDone");

    meInput.value=state.users.me||"Alberto";
    partnerInput.value=state.users.partner||"Giorgia";
    remindAtInput.value=state.settings.remindAt||"09:00";
    colorPrimary.value=state.settings.colorPrimary||"#007AFF";
    colorSecondary.value=state.settings.colorSecondary||"#e11d48";
    resurfaceChk.checked=!!state.settings.resurfaceUnfinished;

    meInput.addEventListener("change", ()=>{ state.users.me=meInput.value.trim()||"Alberto"; save(); renderPill(); });
    partnerInput.addEventListener("change", ()=>{ state.users.partner=partnerInput.value.trim()||"Giorgia"; save(); renderPill(); });
    swapBtn.addEventListener("click", ()=>{ state.active = state.active==="me" ? "partner":"me"; save(); renderPill(); });
    remindAtInput.addEventListener("change", ()=>{ const v=remindAtInput.value.trim(); if(/^\d{2}:\d{2}$/.test(v)){ state.settings.remindAt=v; save(); scheduleCheckSoon(); } else { alert("Usa HH:MM"); remindAtInput.value=state.settings.remindAt||"09:00"; } });
    enableNotifsBtn.addEventListener("click", requestNotifs);
    colorPrimary.addEventListener("input", ()=>{ state.settings.colorPrimary=colorPrimary.value; save(); applyTheme(); });
    colorSecondary.addEventListener("input", ()=>{ state.settings.colorSecondary=colorSecondary.value; save(); applyTheme(); });
    resurfaceChk.addEventListener("change", ()=>{ state.settings.resurfaceUnfinished=resurfaceChk.checked; save(); render(); });

    clearDoneBtn.addEventListener("click", ()=>{ state.tasks=state.tasks.filter(t=>!t.done); save(); render(); });

    exportBtn.addEventListener("click", async ()=>{
      const payload=JSON.stringify(state,null,2);
      const file=new File([payload], "pulizie-export-"+todayYMD()+".json",{type:"application/json"});
      if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
        try{ await navigator.share({title:"Pulizie", files:[file], text:"Esporta elenco pulizie"}); }catch(e){}
      }else{
        const a=document.createElement("a"); a.href=URL.createObjectURL(file); a.download=file.name; a.click(); URL.revokeObjectURL(a.href);
      }
    });
    importInput.addEventListener("change", async (e)=>{
      const file=e.target.files[0]; if(!file) return;
      try{
        const incoming=JSON.parse(await file.text());
        const map=new Map(state.tasks.map(t=>[t.id,t]));
        for(const t of (incoming.tasks||[])){ if(map.has(t.id)){const local=map.get(t.id); map.set(t.id,{...local,...t, done:local.done||t.done}); }else map.set(t.id,t); }
        state.tasks=[...map.values()];
        state.users={...state.users, ...(incoming.users||{})};
        state.settings={...state.settings, ...(incoming.settings||{})};
        const hist=new Set((state.history||[]).map(h=>h.k));
        for(const h of (incoming.history||[])){ if(!h.k) h.k=h.id+"@"+(h.when||""); if(!hist.has(h.k)){ hist.add(h.k); (state.history||[]).push(h);} }
        save(); render(); alert("Import completato ‚úÖ");
      }catch(err){ alert("Import non riuscito: "+err); }
      finally{ e.target.value=""; }
    });
    backupBtn.addEventListener("click", ()=>{
      const payload=JSON.stringify(state,null,2);
      const file=new File([payload],"pulizie-backup-"+todayYMD()+".json",{type:"application/json"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(file); a.download=file.name; a.click(); URL.revokeObjectURL(a.href);
    });
    restoreBtn.addEventListener("click", ()=>{
      const input=document.createElement("input"); input.type="file"; input.accept="application/json";
      input.onchange=async e=>{
        const f=e.target.files[0]; if(!f) return;
        try{ state=JSON.parse(await f.text()); save(); render(); scheduleCheckSoon(); }catch(err){ alert("Ripristino non riuscito: "+err); }
      }; input.click();
    });

    /* Notifiche locali */
    function requestNotifs(){
      if(!("Notification" in window)){ alert("Notifiche non supportate"); return; }
      if(Notification.permission==="granted"){ alert("Notifiche gi√† abilitate ‚úÖ"); return; }
      Notification.requestPermission().then(p=>{ if(p==="granted"){ alert("Notifiche abilitate ‚úÖ"); scheduleCheckSoon(); } else { alert("Notifiche non abilitate"); } });
    }
    function reminderDateFor(dayDate){
      const [hh,mm]=(state.settings.remindAt||"09:00").split(":").map(n=>parseInt(n,10));
      const d=new Date(dayDate); d.setHours(hh||9,mm||0,0,0); return d;
    }
    function shouldNotify(t){
      if(t.done) return false;
      const s=statusForTask(t); if(!s.next) return false;
      const today=todayYMD(); const key=t.id+"@"+today; if(state.notified[key]) return false;
      const now=new Date();
      if(s.dueSoon){ return now>=reminderDateFor(s.next); }
      if(s.overdue){ return now>=reminderDateFor(new Date(today+"T00:00:00")); }
      return false;
    }
    function notifyTask(t){
      state.notified[t.id+"@"+todayYMD()]=true; save();
      const s=statusForTask(t); const title="Promemoria pulizie";
      const body=`${t.title}${t.assignee? " ("+t.assignee+")":""} ‚Äî Prossima: ${humanNext(s)}`;
      if(navigator.serviceWorker?.ready){
        navigator.serviceWorker.ready.then(reg=>{
          if(reg.showNotification){ reg.showNotification(title,{body,icon:"./icons/icon-192.png",badge:"./icons/icon-192.png",tag:t.id}); }
          else if("Notification" in window && Notification.permission==="granted"){ new Notification(title,{body}); }
        });
      }else if("Notification" in window && Notification.permission==="granted"){ new Notification(title,{body}); }
    }
    let checkTimer=null;
    function scheduleCheckSoon(){ if(checkTimer) clearTimeout(checkTimer); checkTimer=setTimeout(runNotificationScan,700); }
    function runNotificationScan(){ if(!("Notification" in window) || Notification.permission!=="granted") return; const pending=state.tasks.filter(shouldNotify); for(const t of pending) notifyTask(t); }
    setInterval(runNotificationScan, 60000);

    /* Init */
    renderPill(); render();

    /* Prevenzione scroll orizzontale nei modali */
    document.querySelectorAll('.modal .content').forEach(el=>{
      el.addEventListener('wheel', (e)=>{ if(Math.abs(e.deltaX)>Math.abs(e.deltaY)) e.preventDefault(); }, {passive:false});
    });
  </script>
</body>
</html>
