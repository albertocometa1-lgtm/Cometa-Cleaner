<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Pulizie di Casa</title>
<link rel="manifest" href="/manifest.json?v=1">
<link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Sappylo">
<meta name="theme-color" content="#000000">
<style>
:root{
  --brand:#007AFF; --brand-2:#7C3AED;
  --bg:#F4F7FF; --card:#FFFFFF; --text:#0D1321; --muted:#5B6B86; --border:#E3E8F5;
  --shadow:0 4px 12px rgba(15,23,42,.06);
  --radius:16px; --fs-1:18px; --fs-2:16px; --fs-3:14px;
  --c-future:#ffffff; --c-future-text:#0D1321;
  --c-due:#FFD166; --c-due-text:#0D1321;
  --c-over:#FF6B6B; --c-over-text:#ffffff;
  --c-done:#06D6A0; --c-done-text:#0D1321;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --safe-top: env(safe-area-inset-top, 0px);
  --bottom-nav-h: 80px; /* viene aggiornato da JS */
}
@media (prefers-color-scheme: dark){
  :root{
    --bg:#0E1220; --card:#12182A; --text:#ECF2FF; --muted:#A8B3C7; --border:#1E2640; --shadow:0 4px 12px rgba(0,0,0,.25);
    --c-future:#12182A; --c-future-text:#ECF2FF; --c-due:#B08900; --c-due-text:#ffffff; --c-over:#C0392B; --c-over-text:#ffffff; --c-done:#1B7F5D; --c-done-text:#ECF2FF;
  }
}
@media (display-mode: standalone){
  :root{ --safe-top:0px; --safe-bottom:0px; }
}
*{box-sizing:border-box}
img{max-width:100%;height:auto;}
html,body{
  height:100%;
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial;
  min-height:100svh;
  min-height:100dvh; /* evita tagli su mobile con barra URL dinamica */
}
html{
  scroll-padding-top:calc(56px + var(--safe-top));
  scroll-padding-bottom:var(--bottom-nav-h);
}
body{
  background:var(--bg);
  color:var(--text);
  line-height:1.45;
  overflow-x:hidden;
  padding-bottom:calc(var(--bottom-nav-h, 80px) + var(--safe-bottom));
}
header{
  position:sticky; top:0; z-index:30;
  background:linear-gradient(0deg, rgba(255,255,255,.92), rgba(255,255,255,.98));
  backdrop-filter:saturate(140%) blur(6px);
  box-shadow:var(--shadow);
  padding:calc(10px + var(--safe-top)) 12px 10px;
  display:flex; align-items:center; gap:10px;
}
@media (prefers-color-scheme: dark){
  header{ background:linear-gradient(0deg, rgba(10,14,28,.92), rgba(10,14,28,.98)); }
}
header h1{font-size:var(--fs-1); margin:0; flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
.logo{width:26px;height:26px;border-radius:6px;object-fit:cover;border:1px solid var(--border); background:linear-gradient(135deg,var(--brand),var(--brand-2));}
.user-pill{display:flex; align-items:center; gap:8px; border:1px solid var(--border); padding:6px 10px; border-radius:999px; background:#E6F7FF;}
.avatar{width:20px; height:20px; border-radius:50%; object-fit:cover; background:var(--brand-2);}
.container{max-width:860px; margin:0 auto; padding:12px; display:flex; flex-direction:column; min-height:calc(100svh - (56px + var(--safe-top)) - var(--bottom-nav-h)); min-height:calc(100dvh - (56px + var(--safe-top)) - var(--bottom-nav-h));}
.view{display:none; flex-direction:column; flex:1;}
.view.active{display:flex;}
#viewTasks{min-height:0;}
ul#list{list-style:none; padding:0; margin:0; flex:1; overflow:auto;}
ul#list:empty{display:none;}
#empty{flex:1; display:flex; align-items:center; justify-content:center;}

/* Tabs (Da Fare) */
.tabs{display:flex; gap:8px; margin:6px 0 10px}
.tab{flex:0 0 auto; padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:#f3f7ff; font-weight:700; cursor:pointer}
.tab.active{ background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#fff; border-color:transparent;}

/* Lista pulizie */
li.task{ margin:10px 0; border-radius:18px; border:1px solid var(--border); box-shadow:var(--shadow); overflow:hidden; cursor:pointer; }
.task-head{ display:flex; align-items:center; gap:10px; padding:12px 14px; }
.chk input{ width:26px; height:26px; }
.head-main{ flex:1; min-width:0; }
.title{ font-weight:800; font-size:var(--fs-2); word-break:break-word; }
.notes-line{ font-size:var(--fs-3); opacity:.9; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:2px;}
.date-badge{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(0,0,0,.08); background:rgba(255,255,255,.35)}
.chev{ transition:transform .2s } li.task.expanded .chev{ transform:rotate(90deg); }
.task-details{ display:none; padding:10px 14px 14px; border-top:1px dashed rgba(0,0,0,.12); }
li.task.expanded .task-details{ display:block; }

/* Stato colori */
li.task.future { background:var(--c-future); color:var(--c-future-text); }
li.task.due { background:var(--c-due); color:var(--c-due-text); }
li.task.over { background:var(--c-over); color:var(--c-over-text); }
li.task.done { background:var(--c-done); color:var(--c-done-text); }
li.task.future .date-badge{border-color:rgba(0,0,0,.08)}
li.task.due .date-badge, li.task.over .date-badge, li.task.done .date-badge{ border-color:rgba(255,255,255,.35)}
.badges{ display:flex; flex-wrap:wrap; gap:6px; margin-top:6px}
.badges span{ font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid rgba(0,0,0,.15); background:rgba(255,255,255,.25); }
.assignee-me{ background:rgba(37,99,235,.2)!important; } .assignee-partner{ background:rgba(225,29,72,.2)!important; }
.actions{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap }
.btn{ padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:var(--card); color:var(--text); cursor:pointer; min-height:44px; }
.btn:focus-visible{ outline:2px solid var(--brand); outline-offset:2px; }
.btn.primary{ background:var(--brand); color:#fff; border-color:var(--brand) }
.btn-danger{ background:#E5484D; color:#fff; border-color:#E5484D }
.btn.icon{ padding:6px; min-height:32px; display:flex; align-items:center; justify-content:center; }
.empty{ padding:24px; text-align:center; color:var(--text); opacity:.9; font-size:var(--fs-2) }

/* Forms */
.grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px } .grid .full{ grid-column:1/-1 }
.form-grid{ display:grid; gap:10px; grid-template-columns:1fr; }
.form-grid .full{ grid-column:1/-1; }
@media(min-width:600px){ .form-grid{ grid-template-columns:1fr 1fr; } }
input, select, textarea{ padding:12px; border:1px solid var(--border); border-radius:12px; background:var(--card); color:var(--text); font-size:var(--fs-2) }
textarea{ min-height:80px; resize:vertical }
.toggle{
  appearance:none;
  width:44px;
  height:24px;
  background:var(--border);
  border-radius:12px;
  position:relative;
  cursor:pointer;
  border:none;
}
.toggle:focus-visible{outline:2px solid var(--brand); outline-offset:2px;}
.toggle::before{
  content:"";
  position:absolute;
  top:2px; left:2px;
  width:20px; height:20px;
  background:#fff;
  border-radius:50%;
  transition:transform .2s;
}
.toggle:checked{ background:var(--brand); }
.toggle:checked::before{ transform:translateX(20px); }
.weekdays{ display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
.weekdays label{ display:flex; align-items:center; gap:4px; }
.photo-zone{ border:2px dashed var(--border); border-radius:12px; padding:20px; text-align:center; cursor:pointer; }
.photo-zone.hover{ background:#f3f7ff; }
.photo-preview{ position:relative; margin-top:10px; display:none; }
.photo-preview img{ width:100px; height:100px; object-fit:cover; border-radius:12px; border:1px solid var(--border); }
.photo-preview button{ position:absolute; top:4px; right:4px; }

.filter-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;}
.filter-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.filter-grid .full{grid-column:1/-1;}
.filter-box label{font-weight:600;font-size:var(--fs-2);display:flex;flex-direction:column;gap:4px;}
.filter-box label.check{flex-direction:row;align-items:center;min-height:44px;padding:4px 8px;border:1px solid var(--border);border-radius:12px;}
.filter-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:16px;}
@media(max-width:480px){.filter-grid{grid-template-columns:1fr;}}

/* Bottom nav */
.bottom-nav{
  position:fixed; left:0; right:0; bottom:0; z-index:40; background:var(--card); border-top:1px solid var(--border); box-shadow:0 -4px 12px rgba(0,0,0,.06);
  padding:8px max(12px, env(safe-area-inset-left)) calc(8px + var(--safe-bottom)) max(12px, env(safe-area-inset-right)); display:flex; gap:10px; justify-content:space-around;
}
.tabbtn{ flex:1; padding:10px 12px; border-radius:14px; border:1px solid var(--border); background:#f3f7ff; font-weight:700; cursor:pointer; min-height:44px;}
.tabbtn:focus-visible{ outline:2px solid var(--brand); outline-offset:2px; }
.tabbtn.active{ border-color:var(--brand); color:#fff; background:linear-gradient(135deg,var(--brand),var(--brand-2)) }

/* Sheet editor: overlay alto, copre calendario */
.sheet{
  position:fixed; z-index:5000;
  left:0; right:0; top:clamp(56px, 8svh, 120px); top:clamp(56px, 8dvh, 120px); bottom:0;
  width:100%; max-height:calc(100svh - clamp(56px, 8svh, 120px)); max-height:calc(100dvh - clamp(56px, 8dvh, 120px));
  padding-top:var(--safe-top);
  background:var(--card); border:1px solid var(--border);
  border-radius:18px 18px 0 0; box-shadow:0 -12px 32px rgba(0,0,0,.35);
  display:none; overflow-y:auto;
}
.sheet header{ position:sticky; top:0; background:var(--card); padding:calc(12px + var(--safe-top)) 16px 12px; display:flex; align-items:center; gap:10px; border-bottom:1px solid var(--border); }
.sheet .content{ padding:12px 16px calc(16px + var(--safe-bottom)); }

/* Task full-screen view */
.task-view{
  position:fixed;
  inset:0;
  z-index:6000;
  background:var(--card);
  display:none;
  flex-direction:column;
}
.task-view header{
  display:flex;
  align-items:center;
  gap:10px;
  padding:calc(12px + var(--safe-top)) 16px 12px;
  border-bottom:1px solid var(--border);
}
.task-view .content{
  flex:1;
  overflow:auto;
  padding:16px 16px calc(16px + var(--safe-bottom));
}
.task-view .photos{
  display:flex;
  flex-direction:column;
  gap:10px;
  margin-top:10px;
}
.task-view .photos img{
  width:100%;
  border-radius:12px;
  border:1px solid var(--border);
  object-fit:cover;
}

/* Classifica */
.leader{ display:grid; gap:10px; }
.row{ display:flex; align-items:center; gap:10px; background:var(--card); border:1px solid var(--border); padding:10px; border-radius:14px; box-shadow:var(--shadow); flex-wrap:wrap; overflow:hidden }
.row .pts{ margin-left:auto; font-weight:800 }
.history{ margin-top:12px; }
.event{ display:flex; gap:10px; align-items:center; border:1px dashed var(--border); background:var(--card); padding:8px 10px; border-radius:12px; margin:6px 0; }
.delta{ font-weight:800; }
.delta.pos{ color:#117733 } .delta.neg{ color:#B00020 }

/* Dati & Backup mobile */
.grid-compact{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px; }
.grid-compact > .btn,
.grid-compact > .file-btn{
  width:100%;
  aspect-ratio:1/1;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  overflow:hidden;
}
.btn.block{ width:100%; }
.file-btn{
  display:inline-flex; align-items:center; justify-content:center; gap:8px;
  padding:12px; border:1px solid var(--border); border-radius:12px;
  background:#f3f7ff; cursor:pointer; text-align:center; font-weight:600;
}
.file-btn input[type="file"]{ display:none; }
.small-note{ font-size:12px; opacity:.7; margin-top:8px; }

/* Toast (si posiziona sopra la bottom-nav reale) */
.toast-wrap{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:calc(var(--bottom-nav-h, 80px) + var(--safe-bottom));
  z-index:200; display:flex; flex-direction:column; gap:8px; align-items:center;
}
.toast{ background:#111827; color:#fff; padding:10px 14px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.25); font-weight:600; max-width:90vw; }
@media (prefers-color-scheme: light){ .toast{ background:#1f2937; } }

/* Overlay leggibilit√† su sfondo */
#viewTasks{ position:relative; }
#viewTasks[data-hasbg="1"]::before{ content:""; position:absolute; inset:0; background: var(--bg-overlay, rgba(0,0,0,.28)); pointer-events:none; z-index:0; }
#viewTasks > *{ position:relative; z-index:1; }

/* Drawer filtri (alto-destra, mobile-friendly) */
.drawer{ position:fixed; inset:0; z-index:150; display:none; }
.drawer.open{ display:block; }
.drawer .scrim{ position:absolute; inset:0; background:rgba(0,0,0,.35); }
.drawer .panel{
  position:absolute; right:0; top:0; bottom:auto;
  width:min(420px, 92vw);
  max-height:86svh; max-height:86dvh;
  background:var(--card);
  border-left:1px solid var(--border);
  box-shadow:var(--shadow);
  transform:translateY(-100%);
  transition:transform .24s ease;
  padding:14px;
  overflow:auto;
  margin-top:calc(8px + var(--safe-top));
  border-radius:0 0 0 16px;
  overscroll-behavior:contain;
}
.drawer.open .panel{ transform:none; }
@media (max-width:560px){
  .drawer .panel{
    left:0; right:0; width:100%; border-left:none; border-radius:0 0 16px 16px;
  }
}

/* Calendario */
.cal-toolbar{ display:flex; align-items:center; gap:8px; margin:8px 0 12px; }
.cal-title{ font-weight:800; font-size:var(--fs-1); flex:1; text-align:center; }
.cal-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }
.cal-dow{ text-align:center; font-weight:700; font-size:12px; opacity:.8; padding:6px 0; }
.cal-cell{
  background:var(--card); border:1px solid var(--border); border-radius:10px; padding:8px; min-height:64px; position:relative;
  display:flex; flex-direction:column; gap:6px; box-shadow:var(--shadow);
}
.cal-daynum{ font-weight:800; font-size:12px; opacity:.9; }
.cal-badge{
  position:absolute; top:8px; right:8px; font-size:11px; padding:3px 6px; border-radius:999px; border:1px solid var(--border); background:#f3f7ff;
}
.cal-cell.muted{ opacity:.55; }
.cal-list{ margin-top:12px; }
.cal-empty{ padding:12px; text-align:center; opacity:.8; }

/* Accordion moderno (Impostazioni, un solo open alla volta) */
.accordion details{
  border:1px solid var(--border);
  border-radius:14px;
  margin:10px 0;
  background:var(--card);
  box-shadow:var(--shadow);
  overflow:hidden;
}
.accordion summary{
  list-style:none;
  cursor:pointer;
  padding:12px 14px;
  font-weight:800;
  display:flex; align-items:center; gap:10px;
}
.accordion summary::-webkit-details-marker{ display:none; }
.accordion details[open] summary{
  background:linear-gradient(135deg,var(--brand),var(--brand-2));
  color:#fff; border-bottom:1px solid var(--border);
}
.accordion details > *:not(summary){ padding:12px 14px; }
</style>
</head>
<body>
<header>
  <img id="appLogo" class="logo" alt="Logo">
  <h1 id="appTitle">Pulizie di Casa</h1>
  <span class="user-pill" id="userPill">
    <img id="avatar" class="avatar" alt="">
    <strong id="who">Utente</strong>
  </span>
</header>

<main class="container">
  <!-- VIEW: DA FARE -->
  <section id="viewTasks" class="view active" style="background-size:cover;background-position:center">
    <div class="tabs">
      <button class="tab active" data-scope="oggi">Oggi</button>
      <button class="tab" data-scope="tutte">Tutte</button>
      <button class="btn" id="toggleFilters" style="margin-left:auto">Filtri</button>
    </div>
    <div class="chips" id="activeChips" style="margin:0 0 8px 0"></div>
    <ul id="list"></ul>
    <div class="empty" id="empty" style="display:none">Niente da mostrare üßΩ</div>
  </section>

  <!-- VIEW: CALENDARIO -->
  <section id="viewCalendar" class="view">
    <div class="cal-toolbar">
      <button id="calPrev" class="btn" aria-label="Mese precedente">‚óÄ</button>
      <div id="calTitle" class="cal-title">Mese Anno</div>
      <button id="calNext" class="btn" aria-label="Mese successivo">‚ñ∂</button>
    </div>
    <div style="display:flex; gap:8px; margin-bottom:8px;">
      <button id="calToday" class="btn">Oggi</button>
      <button id="calAdd" class="btn primary" style="margin-left:auto">Aggiungi pulizie</button>
    </div>
    <div id="calGrid" class="cal-grid" aria-label="Calendario mensile"></div>
    <div id="calDayList" class="cal-list"></div>
  </section>

  <!-- VIEW: CLASSIFICA -->
  <section id="viewRank" class="view">
    <h2>Classifica</h2>
    <div id="leader" class="leader"></div>
    <details class="history" open>
      <summary>Storico punteggi</summary>
      <div id="historyList"></div>
    </details>
    <p class="muted">Regole: +10 in tempo, +5 in anticipo, +2 in ritardo, -5 malus/d√¨ ignorato (overdue non completato).</p>
  </section>

  <!-- VIEW: IMPOSTAZIONI -->
  <section id="viewSettings" class="view">
    <h2>Impostazioni</h2>
    <div id="settingsAccordion" class="accordion">
      <details open>
        <summary>Utente attivo</summary>
        <div class="grid" style="margin-top:10px">
          <select id="activeUser"></select>
          <button id="swapToActive" class="btn">Imposta attivo</button>
        </div>
      </details>
      <details>
        <summary>Gestione utenti</summary>
        <div id="usersList" class="grid" style="margin-top:10px"></div>
        <hr>
        <div class="grid">
          <input id="u-name" placeholder="Nome utente">
          <select id="u-color"></select>
          <label class="btn">Foto utente <input id="u-photo" type="file" accept="image/*" style="display:none"></label>
          <button id="u-add" class="btn primary">Aggiungi utente</button>
        </div>
      </details>
      <details>
        <summary>Stanze</summary>
        <div class="grid" id="roomsList" style="margin-top:10px"></div>
        <hr>
        <div class="grid">
          <input id="r-name" placeholder="Nuova stanza">
          <label class="btn">Foto stanza <input id="r-photo" type="file" accept="image/*" style="display:none"></label>
          <button id="r-add" class="btn primary">Aggiungi stanza</button>
        </div>
      </details>
      <details>
        <summary>Aspetto</summary>
        <div class="grid" style="margin-top:10px">
          <div class="full">
            <strong>Palette app</strong>
            <div id="appPalettes" style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px"></div>
          </div>
          <div class="full">
            <strong>Sfondo sezione ‚ÄúPulizie‚Äù</strong>
            <label class="btn">Carica sfondo <input id="bgTasksFile" type="file" accept="image/*" style="display:none"></label>
            <button id="bgTasksClear" class="btn">Rimuovi sfondo</button>
          </div>
        </div>
      </details>
      <details>
        <summary>Notifiche &amp; Promemoria</summary>
        <div class="grid" style="margin-top:10px">
          <label class="field full">Ora promemoria (HH:MM)
            <input id="remindAt" placeholder="09:00" value="09:00">
          </label>
          <label><input type="checkbox" id="resurface"> Riproponi non completate ogni giorno</label>
          <button id="enableNotifs" class="btn">Abilita notifiche</button>
        </div>
      </details>
      <details>
        <summary>Dati &amp; Backup</summary>
        <div class="grid-compact" style="margin-top:10px">
          <button id="exportTasks" class="btn block">Esporta pulizie</button>
          <label class="file-btn">Importa pulizie
            <input type="file" id="importTasks" accept="application/json">
          </label>
          <button id="exportMyScore" class="btn block">Esporta classifica (utente attivo)</button>
          <label class="file-btn">Importa classifica su utente attivo
            <input type="file" id="importMyScore" accept="application/json">
          </label>
          <button id="backup" class="btn block">Backup completo</button>
          <label class="file-btn">Ripristina backup completo
            <input type="file" id="restoreFile" accept="application/json">
          </label>
          <button id="clearDone" class="btn block">Cancella completate</button>
        </div>
      </details>
      <details>
        <summary>Aggiorna applicazione</summary>
        <div class="grid" style="margin-top:10px">
          <button id="refreshBtn" class="btn">Ricarica applicazione</button>
        </div>
      </details>
    </div>
  </section>
</main>

<!-- Bottom Nav -->
<nav class="bottom-nav">
  <button class="tabbtn active" data-tab="tasks">Da Fare</button>
  <button class="tabbtn" data-tab="calendar">Calendario</button>
  <button class="tabbtn" data-tab="rank">Classifica</button>
  <button class="tabbtn" data-tab="settings">Impostazioni</button>
</nav>

<!-- Filters Drawer -->
<div id="filtersDrawer" class="drawer" aria-hidden="true">
  <div class="scrim" id="filtersScrim"></div>
  <div class="panel" role="dialog" aria-label="Filtri">
    <h3>Filtri</h3>
    <form class="filter-box">
      <div class="filter-grid">
        <label class="full">Cerca
          <input id="f-q" placeholder="Cerca per nome/notes">
        </label>
        <label>Stanza
          <select id="f-room"></select>
        </label>
        <label>Assegnatario
          <select id="f-user"></select>
        </label>
        <label>Priorit√†
          <select id="f-pri">
            <option value="">(tutte)</option>
            <option value="1">Alta</option>
            <option value="2">Media</option>
            <option value="3">Bassa</option>
          </select>
        </label>
        <label>Stato
          <select id="f-state">
            <option value="">(tutti)</option>
            <option value="future">Futuro</option>
            <option value="due">In scadenza oggi</option>
            <option value="over">Scaduto</option>
            <option value="done">Completato</option>
          </select>
        </label>
        <label class="check full"><input type="checkbox" id="f-done-today"> Completate oggi</label>
        <label class="check full"><input type="checkbox" id="f-not-done-today"> Non completate oggi</label>
        <label>Data da
          <input type="date" id="f-from">
        </label>
        <label>Data a
          <input type="date" id="f-to">
        </label>
      </div>
      <div class="filter-actions">
        <button class="btn" id="clearFilters" type="button">Pulisci</button>
        <button class="btn primary" id="closeFilters" type="button">Applica</button>
      </div>
    </form>
  </div>
</div>

<!-- Editor sheet -->
<div id="sheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
  <header>
    <h3 id="sheetTitle" style="margin:0;flex:1">Nuova pulizia</h3>
    <button id="sheetClose" class="btn">Chiudi</button>
  </header>
  <div class="content">
    <form id="taskForm" class="form-grid">
      <input id="f-id" type="hidden">
      <label class="field full">Nome pulizia
        <input id="f-title" placeholder="Es. Passare l'aspirapolvere" required>
      </label>
      <label class="field full">Descrizione
        <textarea id="f-notes" rows="3" placeholder="Dettagli (opzionale)"></textarea>
      </label>
      <label class="field full">Data inizio
        <input id="f-startAt" type="datetime-local" required>
      </label>
      <label class="field full">Ripetizione
        <input id="f-rep-enabled" class="toggle" type="checkbox">
      </label>
      <div id="repFields" class="full" style="display:none">
        <div class="form-grid">
          <label>Intervallo
            <input id="f-rep-every" type="number" min="1" step="1" value="1">
          </label>
          <label>Unit√†
            <select id="f-rep-unit">
              <option value="days">Giorni</option>
              <option value="weeks">Settimane</option>
              <option value="months">Mesi</option>
              <option value="hours">Ore</option>
            </select>
          </label>
        </div>
        <div id="repWeekdays" class="weekdays" style="display:none;">
          <label><input type="checkbox" value="0">L</label>
          <label><input type="checkbox" value="1">M</label>
          <label><input type="checkbox" value="2">M</label>
          <label><input type="checkbox" value="3">G</label>
          <label><input type="checkbox" value="4">V</label>
          <label><input type="checkbox" value="5">S</label>
          <label><input type="checkbox" value="6">D</label>
        </div>
      </div>
      <label class="field full">Foto
        <div id="photoZone" class="photo-zone">Trascina o clicca per caricare</div>
        <div id="photoPreview" class="photo-preview">
          <img id="photoImg" alt="Anteprima">
          <button type="button" class="btn" id="photoRemove">Rimuovi</button>
        </div>
        <input id="f-photo" type="file" accept="image/png, image/jpeg" hidden>
      </label>
      <div class="full" style="display:flex; gap:10px; justify-content:flex-end;">
        <button id="btnDelete" type="button" class="btn btn-danger" style="display:none">Elimina</button>
        <button id="btnSave" class="btn primary" type="submit">Salva</button>
      </div>
    </form>
  </div>
</div>

<!-- Task full-screen view -->
<div id="taskView" class="task-view" role="dialog" aria-modal="true" aria-hidden="true">
  <header>
    <h3 id="tvTitle" style="margin:0;flex:1"></h3>
    <button id="tvClose" class="btn">Chiudi</button>
  </header>
  <div class="content">
    <div id="tvMeta" class="badges"></div>
    <div id="tvNotes" style="margin-top:10px"></div>
    <div id="tvPhotos" class="photos"></div>
    <div id="tvNext" style="margin-top:10px"></div>
    <div id="tvActions" class="actions" style="margin-top:20px"></div>
  </div>
</div>

<!-- Toast container -->
<div id="toastWrap" class="toast-wrap" aria-live="polite" aria-atomic="true"></div>

<script>
/* ===== Stato & storage ===== */
const DBKEY="pulizie-db-v10";
const nowISO=()=>new Date().toISOString();
const todayYMD=()=>new Date().toISOString().slice(0,10);

/* Colori utente: nomi + hex */
const USER_COLORS=[
  {name:"Rosa", hex:"#FF8FA3"},
  {name:"Rosa Chiaro", hex:"#FFB3C1"},
  {name:"Azzurro", hex:"#A0C4FF"},
  {name:"Celeste", hex:"#BDE0FE"},
  {name:"Verde Menta", hex:"#B9FBC0"},
  {name:"Acqua", hex:"#98F5E1"},
  {name:"Albiccocca", hex:"#FFD6A5"},
  {name:"Giallo Chiaro", hex:"#FDFFB6"},
  {name:"Lilla", hex:"#E9B3FF"},
  {name:"Verde Salvia", hex:"#C4F1BE"}
];

/* Palette app */
const APP_PALETTES=[
  {name:"Forest", brand:"#124332", brand2:"#2FBF71", bg:"#DDEEE7"},
  {name:"Desert", brand:"#8A4B12", brand2:"#E0A33A", bg:"#F5E7CD"},
  {name:"Coral", brand:"#9C1B31", brand2:"#FF6F61", bg:"#F9E1E0"},
  {name:"Ocean", brand:"#0B4C75", brand2:"#15C2CE", bg:"#E2F6F8"},
  {name:"Slate", brand:"#2B2D42", brand2:"#8D99AE", bg:"#E7EBF2"},
  {name:"Sunset", brand:"#6C2BD9", brand2:"#FF7A00", bg:"#EFE6FF"}
];

const defaults={
  version:10,
  users:[
    {id:"me", name:"Alberto", color:"#A0C4FF", photo:null},
    {id:"partner", name:"Giorgia", color:"#FF8FA3", photo:null}
  ],
  activeUserId:"me",
  appearance:{ palette:APP_PALETTES[3], bgTasks:null, logo:null },
  settings:{
    remindAt:"09:00",
    resurfaceUnfinished:false,
    rooms:[{name:"Cucina",photo:null},{name:"Soggiorno",photo:null},{name:"Bagno",photo:null},{name:"Camera",photo:null},{name:"Ingresso",photo:null},{name:"Balcone",photo:null},{name:"Altro",photo:null}]
  },
  tasks:[],
  history:[],
  notified:{},
  score:{},
  lastMalusDate:null
};
function migrate(d){
  if(!d.settings?.rooms){ d.settings={...(d.settings||{}), rooms:defaults.settings.rooms}; }
  if(!d.score) d.score={};
  if(!('lastMalusDate' in d)) d.lastMalusDate=null;
  if(!d.users || Array.isArray(d.users)===false){ d.users = defaults.users; d.activeUserId="me"; }
  if(!d.appearance) d.appearance = defaults.appearance;
  return d;
}
function load(){
  const raw=localStorage.getItem(DBKEY);
  if(!raw){ localStorage.setItem(DBKEY, JSON.stringify(defaults)); return structuredClone(defaults); }
  try{ return migrate(JSON.parse(raw)); }catch{ localStorage.setItem(DBKEY, JSON.stringify(defaults)); return structuredClone(defaults); }
}
let state=load();
const save=()=>localStorage.setItem(DBKEY, JSON.stringify(state));

/* ===== Toast ===== */
const toastWrap=document.getElementById("toastWrap");
function showToast(msg, timeout=2200){
  const t=document.createElement("div"); t.className="toast"; t.textContent=msg;
  toastWrap.appendChild(t);
  setTimeout(()=>{ t.style.opacity="0"; t.style.transition="opacity .3s"; }, timeout);
  setTimeout(()=>{ toastWrap.removeChild(t); }, timeout+350);
}

/* Helpers colore/contrasto */
function hexToRgb(h){ const x=h.replace("#",""); const b=parseInt(x.length===3? x.split("").map(c=>c+c).join("") : x,16); return {r:(b>>16)&255, g:(b>>8)&255, b:b&255}; }
function relLum({r,g,b}){ const s=[r,g,b].map(v=>{ v/=255; return v<=0.03928? v/12.92 : Math.pow((v+0.055)/1.055,2.4); }); return 0.2126*s[0]+0.7152*s[1]+0.0722*s[2]; }

/* ===== Util/UI ===== */
function byId(id){ return document.getElementById(id); }
const logoEl=byId("appLogo");
const avatarEl=byId("avatar"), whoEl=byId("who");
const refreshBtn = byId("refreshBtn");
if(refreshBtn){
  refreshBtn.addEventListener("click", () => {
    if("caches" in window){
      caches.keys()
        .then(keys => Promise.all(keys.map(k => caches.delete(k))))
        .finally(() => window.location.reload(true));
    }else{
      window.location.reload(true);
    }
  });
}
function activeUser(){ return state.users.find(u=>u.id===state.activeUserId) || state.users[0]; }
function setActiveUser(id){ state.activeUserId=id; save(); renderHeader(); renderAssigneeSelects(); renderUsersList(); renderLeader(); renderHistory(); }

/* Palette */
function applyPalette(p){
  document.documentElement.style.setProperty("--brand", p.brand);
  document.documentElement.style.setProperty("--brand-2", p.brand2);
  document.documentElement.style.setProperty("--bg", p.bg);
  const L = relLum(hexToRgb(p.bg));
  const darkBg = L < 0.5;
  if(darkBg){
    document.documentElement.style.setProperty("--text", "#ECF2FF");
    document.documentElement.style.setProperty("--card", "#12182A");
    document.documentElement.style.setProperty("--border", "#1E2640");
    document.documentElement.style.setProperty("--c-future", "#12182A");
    document.documentElement.style.setProperty("--c-future-text", "#ECF2FF");
  }else{
    document.documentElement.style.setProperty("--text", "#0D1321");
    document.documentElement.style.setProperty("--card", "#FFFFFF");
    document.documentElement.style.setProperty("--border", "#E3E8F5");
    document.documentElement.style.setProperty("--c-future", "#FFFFFF");
    document.documentElement.style.setProperty("--c-future-text", "#0D1321");
  }
}

/* Header, logo, sfondo */
function renderHeader(){
  const u=activeUser();
  whoEl.textContent=u?.name||"Utente";
  if(u?.photo){ avatarEl.src=u.photo; avatarEl.style.background="transparent"; }
  else { avatarEl.removeAttribute("src"); avatarEl.style.background=u?.color||"#ccc"; }
  logoEl.src = state.appearance.logo || "icons/icon-192.png";
  logoEl.style.background="transparent";
  const viewTasks=document.getElementById("viewTasks");
  if(state.appearance.bgTasks){
    viewTasks.style.backgroundImage = `url(${state.appearance.bgTasks})`;
    viewTasks.setAttribute("data-hasbg","1");
    const L = relLum(hexToRgb(getComputedStyle(document.documentElement).getPropertyValue("--bg").trim()));
    const overlay = L < 0.5 ? "rgba(255,255,255,.22)" : "rgba(0,0,0,.28)";
    document.documentElement.style.setProperty("--bg-overlay", overlay);
  }else{
    viewTasks.style.backgroundImage = "none";
    viewTasks.removeAttribute("data-hasbg");
    document.documentElement.style.removeProperty("--bg-overlay");
  }
}

/* ===== Date helpers (gg-mm-aa) ===== */
function fmtDMY(d){ // gg-mm-aa
  const dd=String(d.getDate()).padStart(2,"0");
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const yy=String(d.getFullYear()).slice(-2);
  return `${dd}-${mm}-${yy}`;
}
function fmtDMYHM(d){ // gg-mm-aa hh:mm
  const hh=String(d.getHours()).padStart(2,"0"), mi=String(d.getMinutes()).padStart(2,"0");
  return `${fmtDMY(d)} ${hh}:${mi}`;
}
function ymdToDMYStr(s){ // "YYYY-MM-DD" -> "gg-mm-aa"
  if(!s) return "";
  const [Y,M,D]=s.split("-");
  return `${D}-${M}-${String(Y).slice(-2)}`;
}

/* ===== Scheduling / Status ===== */
function parseLocal(dt){ return dt ? new Date(dt) : null; }
function addInterval(d,n,u){
  const nd=new Date(d);
  const step = Number(n);
  if(u==="hours") nd.setHours(nd.getHours()+step);
  else if(u==="days") nd.setDate(nd.getDate()+step);
  else if(u==="weeks") nd.setDate(nd.getDate()+7*step);
  else nd.setMonth(nd.getMonth()+step);
  return nd;
}
function nextOccurrenceFromStart(start,every,unit,ref,weekdays=[]){
  if(!start) return null;
  let cur=new Date(start);
  if(!every||every<1) every=1;
  if(unit==="weeks" && weekdays.length){
    const baseDow=(cur.getDay()+6)%7;
    const baseWeekStart=new Date(cur); baseWeekStart.setDate(cur.getDate()-baseDow);
    let weekStart=new Date(baseWeekStart);
    let guard=0;
    while(guard++<800){
      const diffWeeks=Math.round((weekStart-baseWeekStart)/604800000);
      if(diffWeeks%every===0){
        for(const wd of weekdays){
          const cand=new Date(weekStart);
          cand.setDate(weekStart.getDate()+wd);
          cand.setHours(cur.getHours(),cur.getMinutes(),0,0);
          if(cand>=cur && cand>=ref) return cand;
        }
      }
      weekStart.setDate(weekStart.getDate()+7);
    }
    return null;
  }
  if(unit==="hours"){
    let guard=0;
    while(cur<ref && guard++<800){ cur=addInterval(cur,every,"hours"); }
    return cur;
  }
  if(cur>=ref) return cur;
  let guard=0;
  while(cur<ref && guard++<800){ cur=addInterval(cur,every,unit); }
  return cur;
}
function isSameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
function statusForTask(t){
  const now=new Date();
  const start=parseLocal(t.startAt);
  if(!start) return { next:null, code: t.done?"done":"future" };
  const next=t.repeat?.enabled ? nextOccurrenceFromStart(start, t.repeat.every, t.repeat.unit, now, t.repeat.weekdays||[]) : start;
  if(t.done) return { next, code:"done" };
  if(!next) return { next:null, code:"future" };
  if(isSameDay(next, now)) return { next, code:"due" };
  if(next < now) return { next, code:"over" };
  return { next, code:"future" };
}

/* ===== Occorrenze per Calendario ===== */
function occursOnDay(task, day){
  const start = parseLocal(task.startAt);
  if(!start) return false;
  const sDay = new Date(start.getFullYear(), start.getMonth(), start.getDate());
  const dDay = new Date(day.getFullYear(), day.getMonth(), day.getDate());

  if(!task.repeat?.enabled){
    return isSameDay(sDay, dDay);
  }
  const every = Math.max(1, parseInt(task.repeat.every||"1",10));
  const unit = task.repeat.unit;

  if(unit==="hours"){
    const dayStart=new Date(dDay); dayStart.setHours(0,0,0,0);
    const dayEnd=new Date(dayStart); dayEnd.setDate(dayEnd.getDate()+1);
    let cur=new Date(start);
    let guard=0;
    if(cur>=dayEnd) return false;
    while(cur<dayStart && guard++<800){ cur=addInterval(cur,every,"hours"); }
    return cur>=dayStart && cur<dayEnd;
  }

  if(dDay < sDay) return false;

  if(unit==="days"){
    const diff = Math.round((dDay - sDay)/86400000);
    return diff % every === 0;
  }else if(unit==="weeks"){
    const wds = task.repeat.weekdays || [];
    const dDow = (dDay.getDay()+6)%7;
    if(wds.length && !wds.includes(dDow)) return false;
    const startDow = (sDay.getDay()+6)%7;
    const startWeekStart=new Date(sDay); startWeekStart.setDate(sDay.getDate()-startDow);
    const dWeekStart=new Date(dDay); dWeekStart.setDate(dDay.getDate()-dDow);
    const diffWeeks = Math.round((dWeekStart - startWeekStart)/(86400000*7));
    return diffWeeks % every === 0;
  }else{
    const diffMonths = (dDay.getFullYear()*12 + dDay.getMonth()) - (sDay.getFullYear()*12 + sDay.getMonth());
    if(diffMonths % every !== 0) return false;
    const target = new Date(sDay);
    target.setMonth(sDay.getMonth() + diffMonths);
    const lastDay = new Date(target.getFullYear(), target.getMonth()+1, 0).getDate();
    const dayNum = Math.min(sDay.getDate(), lastDay);
    const clamp = new Date(target.getFullYear(), target.getMonth(), dayNum);
    return isSameDay(clamp, dDay);
  }
}

/* ===== Tabs Da Fare & Filtri ===== */
let scope="oggi";
document.querySelectorAll(".tab").forEach(b=> b.addEventListener("click", ()=>{
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
  scope=b.dataset.scope;
  renderTasks();
}));

const drawer=byId("filtersDrawer"), scrim=byId("filtersScrim"), closeFilters=byId("closeFilters"), toggleFilters=byId("toggleFilters"), chipsEl=byId("activeChips");
toggleFilters.addEventListener("click", ()=> drawer.classList.add("open"));
scrim.addEventListener("click", ()=> drawer.classList.remove("open"));
closeFilters.addEventListener("click", ()=>{ drawer.classList.remove("open"); renderChips(); renderTasks(); });
const filterInputs={
  q: byId("f-q"), room: byId("f-room"), user: byId("f-user"), pri: byId("f-pri"),
  state: byId("f-state"), doneToday: byId("f-done-today"), notDoneToday: byId("f-not-done-today"),
  from: byId("f-from"), to: byId("f-to")
};
Object.values(filterInputs).forEach(el=> el.addEventListener("input", ()=>{ renderChips(); }));

function renderRoomFilters(){ filterInputs.room.innerHTML=`<option value="">(tutte)</option>` + state.settings.rooms.map(r=>`<option value="${r.name}">${r.name}</option>`).join(""); }
function renderUserFilters(){ filterInputs.user.innerHTML=`<option value="">(tutti)</option>` + state.users.map(u=>`<option value="${u.name}">${u.name}</option>`).join(""); }
function renderChips(){
  const chips=[];
  const {q,room,user,pri,state,doneToday,notDoneToday,from,to}=filterInputs;
  if(q.value) chips.push(`testo:‚Äú${q.value}‚Äù`);
  if(room.value) chips.push(`stanza:${room.value}`);
  if(user.value) chips.push(`utente:${user.value}`);
  if(pri.value) chips.push(`prio:${pri.value}`);
  if(state.value) chips.push(`stato:${state.value}`);
  if(doneToday.checked) chips.push("completate:oggi");
  if(notDoneToday.checked) chips.push("non completate:oggi");
  if(from.value||to.value) chips.push(`data:${from.value? ymdToDMYStr(from.value):".."}‚Üí${to.value? ymdToDMYStr(to.value):".."}`);
  chipsEl.innerHTML=chips.map(c=>`<span class="chip">${c}</span>`).join("");
}

/* ===== LISTA PULIZIE ===== */
const listEl=byId("list"), emptyEl=byId("empty");
function baseTasksForScope(){
  const tasks=[...state.tasks];
  if(scope==="oggi"){
    const todayStart=new Date(todayYMD()+"T00:00:00");
    return tasks.filter(t=>{
      if(t.done) return false;
      const s=statusForTask(t);
      if(s.code==="due") return true;
      if(state.settings.resurfaceUnfinished){
        const start=parseLocal(t.startAt); if(!start) return false;
        if(t.repeat?.enabled){
          const prev=nextOccurrenceFromStart(start, t.repeat.every, t.repeat.unit, new Date(todayStart - 1), t.repeat.weekdays||[]);
          if(prev && prev < todayStart) return true;
        } else if(start < todayStart){ return true; }
      }
      return false;
    });
  }
  return tasks;
}
function applyFilters(list){
  const {q,room,user,pri,state,doneToday,notDoneToday,from,to}=filterInputs;
  const qv=q.value.trim().toLowerCase();
  const fromD=from.value? new Date(from.value+"T00:00:00"):null;
  const toD=to.value? new Date(to.value+"T23:59:59"):null;
  return list.filter(t=>{
    const s=statusForTask(t);
    if(qv && !((t.title||t.name||"").toLowerCase().includes(qv) || (t.notes||"").toLowerCase().includes(qv))) return false;
    if(room.value && t.room!==room.value) return false;
    if(user.value && t.assignee!==user.value) return false;
    if(pri.value && String(t.priority)!==String(pri.value)) return false;
    if(state.value && s.code!==state.value) return false;
    const last = t.lastDone ? new Date(t.lastDone) : null;
    const isDoneToday = last ? isSameDay(last,new Date()) : false;
    if(doneToday.checked && !isDoneToday) return false;
    if(notDoneToday.checked && isDoneToday) return false;
    if(fromD || toD){
      if(!s.next) return false;
      if(fromD && s.next < fromD) return false;
      if(toD && s.next > toD) return false;
    }
    return true;
  });
}
function renderTasks(){
  renderRoomSelect(); renderAssigneeSelects(); renderRoomFilters(); renderUserFilters();
  listEl.innerHTML=""; emptyEl.style.display="none";
  const tasks = applyFilters(baseTasksForScope()).sort((a,b)=>{
    const sa=statusForTask(a), sb=statusForTask(b);
    const na=sa.next||new Date("9999-12-31"), nb=sb.next||new Date("9999-12-31");
    return (a.done-b.done)||(a.priority-b.priority)||(na-nb);
  });
  if(!tasks.length){ emptyEl.style.display="block"; return; }
  for(const t of tasks){
    const s=statusForTask(t);
    const li=document.createElement("li"); li.className=`task ${s.code}`; li.dataset.id=t.id;

    // Accessibilit√† + interazioni su tutta la card
    li.setAttribute("tabindex", "0");
    li.setAttribute("role", "button");

    const head=document.createElement("div"); head.className="task-head";
    const chk=document.createElement("div"); chk.className="chk";
    const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=!!t.done;
    cb.addEventListener("click", ev=>ev.stopPropagation()); // non apre/chiude la card
    cb.addEventListener("change", ()=>{
      const userName = t.assignee || activeUser().name;
      const prev = t.lastScore || 0;
      if(cb.checked){
        t.done = true;
        t.lastDone = nowISO();
        const newScore = computeScoreFor(t, new Date());
        const delta = newScore - prev;
        t.lastScore = newScore;
        applyScoreDelta(userName, delta, "aggiornamento punteggio (chiusura)", t);
        showToast("‚úÖ Pulizia completata");
      }else{
        t.done = false;
        t.lastDone = null;
        const delta = - (t.lastScore || 0);
        t.lastScore = 0;
        applyScoreDelta(userName, delta, "rimozione punteggio (riaperta)", t);
        showToast("‚Ü©Ô∏è Pulizia riaperta");
      }
      save(); renderTasks(); renderLeader(); renderHistory(); renderCalendar();
    });
    chk.appendChild(cb);

    const headMain=document.createElement("div"); headMain.className="head-main";
    const title=document.createElement("div"); title.className="title"; title.textContent=t.title || t.name;
    const notesLine=document.createElement("div"); notesLine.className="notes-line"; const photoTag=t.photo?" üì∑":""; notesLine.textContent = (t.notes||"")+photoTag;
    headMain.appendChild(title); headMain.appendChild(notesLine);
    const dateBadge=document.createElement("div"); dateBadge.className="date-badge"; dateBadge.textContent = s.next ? fmtDMY(s.next) : "--";
    const chev=document.createElement("div"); chev.className="chev"; chev.innerHTML=`<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" d="M9 6l6 6-6 6"/></svg>`;
    head.appendChild(chk); head.appendChild(headMain); head.appendChild(dateBadge); head.appendChild(chev);
    li.appendChild(head);

    // Apri la pagina dettagli cliccando ovunque sulla card (tranne controlli interattivi)
    li.addEventListener("click", (ev)=>{
      const tag = (ev.target.tagName || "").toLowerCase();
      if (tag === "input" || tag === "button" || tag === "select" || tag === "textarea" || ev.target.closest("button, input, select, textarea")) return;
      openTaskView(t);
    });
    // Supporto tastiera
    li.addEventListener("keydown", (ev)=>{
      if(ev.key === "Enter" || ev.key === " "){
        ev.preventDefault();
        openTaskView(t);
      }
    });

    listEl.appendChild(li);
  }
}

/* ===== EDITOR ===== */
const sheet=byId("sheet"), sheetTitle=byId("sheetTitle"), sheetClose=byId("sheetClose");
const form=byId("taskForm");
const fId=byId("f-id"), fTitle=byId("f-title"), fStartAt=byId("f-startAt"),
      fRepEnabled=byId("f-rep-enabled"), fRepEvery=byId("f-rep-every"), fRepUnit=byId("f-rep-unit"),
      fNotes=byId("f-notes"), repFields=byId("repFields"), repWeekdays=byId("repWeekdays"),
      photoInput=byId("f-photo"), photoZone=byId("photoZone"), photoPreview=byId("photoPreview"),
      photoImg=byId("photoImg"), photoRemove=byId("photoRemove"),
      fRoomSel=byId("f-roomSel"), fAssignee=byId("f-assignee"),
      btnSave=byId("btnSave"), btnDelete=byId("btnDelete");
const taskView=byId("taskView"), tvTitle=byId("tvTitle"), tvClose=byId("tvClose"),
      tvMeta=byId("tvMeta"), tvNotes=byId("tvNotes"), tvPhotos=byId("tvPhotos"),
      tvNext=byId("tvNext"), tvActions=byId("tvActions");
let photoData=null;

function renderRoomSelect(){ if(!fRoomSel) return; fRoomSel.innerHTML = `<option value="">(Nessuna)</option>` + state.settings.rooms.map(r=>`<option>${r.name}</option>`).join(""); }
function renderAssigneeSelects(){ if(!fAssignee) return; const opts = state.users.map(u=>`<option value="${u.name}">${u.name}</option>`).join(""); fAssignee.innerHTML = `<option value="">(nessuno)</option>`+opts; }

if(fNotes){
  fNotes.addEventListener('input', ()=>{ fNotes.style.height='auto'; fNotes.style.height=fNotes.scrollHeight+'px'; });
}
fRepEnabled.addEventListener('change', ()=>{
  repFields.style.display = fRepEnabled.checked ? 'block' : 'none';
  if(!fRepEnabled.checked){
    fRepEvery.value = 1; fRepUnit.value = 'days';
    repWeekdays.style.display='none';
    repWeekdays.querySelectorAll('input').forEach(cb=>cb.checked=false);
  }
});
fRepUnit.addEventListener('change', ()=>{
  repWeekdays.style.display = fRepUnit.value==='weeks' ? 'flex' : 'none';
});
function getSelectedWeekdays(){
  return Array.from(repWeekdays.querySelectorAll('input:checked')).map(cb=>parseInt(cb.value,10));
}
photoZone.addEventListener('click', ()=> photoInput.click());
photoZone.addEventListener('dragover', e=>{ e.preventDefault(); photoZone.classList.add('hover'); });
photoZone.addEventListener('dragleave', ()=> photoZone.classList.remove('hover'));
photoZone.addEventListener('drop', e=>{ e.preventDefault(); photoZone.classList.remove('hover'); handlePhotoFile(e.dataTransfer.files[0]); });
photoInput.addEventListener('change', ()=> handlePhotoFile(photoInput.files[0]));
photoRemove.addEventListener('click', ()=>{ photoData=null; photoPreview.style.display='none'; photoInput.value=''; });
function handlePhotoFile(file){
  if(!file) return;
  if(!/image\/(jpeg|png)/.test(file.type)){ alert('Solo immagini JPG/PNG'); return; }
  if(file.size > 5*1024*1024){ alert('Max 5MB'); return; }
  const r=new FileReader();
  r.onload=()=>{ photoData=r.result; photoImg.src=photoData; photoPreview.style.display='block'; };
  r.readAsDataURL(file);
}
function openEditor(task=null){
  sheet.style.display="block";
  if(task){
    sheetTitle.textContent="Modifica pulizia";
    fId.value=task.id;
    fTitle.value=task.title||task.name||"";
    fNotes.value=task.notes||task.description||"";
    fStartAt.value=task.startAt||task.start_at||new Date().toISOString().slice(0,16);
    fRepEnabled.checked=!!task.repeat?.enabled;
    fRepEvery.value=task.repeat?.every||1;
    fRepUnit.value=task.repeat?.unit||"days";
    repFields.style.display = fRepEnabled.checked ? "block" : "none";
    repWeekdays.style.display = (fRepUnit.value==="weeks") ? "flex" : "none";
    const wds = task.repeat?.weekdays || [];
    repWeekdays.querySelectorAll('input').forEach(cb=>{ cb.checked = wds.includes(parseInt(cb.value,10)); });
    photoData = task.photo || null;
    if(photoData){
      photoImg.src=photoData; photoPreview.style.display="block";
    }else{ photoPreview.style.display="none"; photoInput.value=""; }
    btnDelete.style.display="inline-flex";
  }else{
    sheetTitle.textContent="Nuova pulizia";
    fId.value="";
    fTitle.value=""; fNotes.value="";
    fStartAt.value=new Date().toISOString().slice(0,16);
    fRepEnabled.checked=false; fRepEvery.value=1; fRepUnit.value="days";
    repFields.style.display="none"; repWeekdays.style.display="none";
    repWeekdays.querySelectorAll('input').forEach(cb=>cb.checked=false);
    photoData=null; photoInput.value=""; photoPreview.style.display="none";
    btnDelete.style.display="none";
  }
}
function closeEditor(){ sheet.style.display="none"; }
sheetClose.addEventListener("click", closeEditor);

function openTaskView(task){
  tvTitle.textContent = task.title || task.name;
  tvMeta.innerHTML = "";
  if(task.repeat?.enabled){
    let unitLabel = task.repeat.unit==="days"?"giorni":task.repeat.unit==="weeks"?"settimane":task.repeat.unit==="months"?"mesi":"ore";
    let extra = "";
    if(task.repeat.unit==="weeks" && task.repeat.weekdays && task.repeat.weekdays.length){
      const labs=["L","M","M","G","V","S","D"];
      extra = ` (${task.repeat.weekdays.map(i=>labs[i]).join(",")})`;
    }
    tvMeta.innerHTML += `<span>Ogni ${task.repeat.every} ${unitLabel}${extra}</span>`;
  }else{
    tvMeta.innerHTML += `<span>Singolo</span>`;
  }
  tvNotes.textContent = task.notes || task.description || "";
  tvPhotos.innerHTML = "";
  if(task.photo){
    const im=document.createElement("img"); im.src=task.photo; tvPhotos.appendChild(im);
  }else if(task.photos && task.photos.length){
    task.photos.forEach(src=>{ const im=document.createElement("img"); im.src=src; tvPhotos.appendChild(im); });
  }
  const s = statusForTask(task);
  tvNext.innerHTML = `Prossima occorrenza: <strong>${s.next? fmtDMYHM(s.next) : "--"}</strong>`;
  tvActions.innerHTML = "";
  const editBtn=document.createElement("button"); editBtn.className="btn"; editBtn.textContent="Modifica";
  editBtn.addEventListener("click", ()=>{ closeTaskView(); openEditor(task); });
  tvActions.appendChild(editBtn);
  taskView.style.display="flex";
  taskView.setAttribute("aria-hidden","false");
}
function closeTaskView(){
  taskView.style.display="none";
  taskView.setAttribute("aria-hidden","true");
}
tvClose.addEventListener("click", closeTaskView);

btnDelete.addEventListener("click", ()=>{
  if(!fId.value) return;
  if(confirm("Eliminare questa pulizia?")){
    const t = state.tasks.find(x=>x.id===fId.value);
    if(t && (t.lastScore||0)){
      const userName = t.assignee || activeUser().name;
      applyScoreDelta(userName, -(t.lastScore||0), "rimozione punteggio (task eliminato)", t);
    }
    state.tasks = state.tasks.filter(t=>t.id!==fId.value);
    save(); closeEditor(); renderTasks(); renderCalendar(); renderLeader(); renderHistory();
    showToast("üóëÔ∏è Pulizia eliminata");
  }
});

/* Foto helpers */
function fileToDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); }); }

form.addEventListener("submit", (e)=>{
  e.preventDefault();
  const prevTask = state.tasks.find(t=>t.id===fId.value);
  const data={
    id: fId.value || crypto.randomUUID(),
    title: fTitle.value.trim(),
    room: prevTask?.room || "",
    priority: prevTask?.priority || 2,
    assignee: prevTask?.assignee || "",
    startAt: fStartAt.value || null,
    repeat:{
      enabled:fRepEnabled.checked,
      every:fRepEnabled.checked? parseInt(fRepEvery.value||"1",10) : 1,
      unit:fRepEnabled.checked? fRepUnit.value : "days",
      weekdays:fRepEnabled.checked && fRepUnit.value==="weeks" ? getSelectedWeekdays() : []
    },
    notes: fNotes.value.trim(),
    photo: photoData,
    createdAt: fId.value ? prevTask?.createdAt : nowISO(),
    lastDone: fId.value ? (prevTask?.lastDone || null) : null,
    lastScore: fId.value ? (prevTask?.lastScore || 0) : 0,
    done: fId.value ? (prevTask?.done || false) : false
  };

  const idx=state.tasks.findIndex(t=>t.id===data.id);
  if(idx===-1){ state.tasks.push(data); showToast("‚ûï Pulizia aggiunta"); }
  else { state.tasks[idx]={...state.tasks[idx], ...data}; showToast("üíæ Modifiche salvate"); }

  photoInput.value=""; photoPreview.style.display='none'; photoData=null;
  save(); closeEditor(); renderTasks(); renderCalendar();
});

/* ===== Scoring ===== */
const leaderEl=byId("leader"), historyList=byId("historyList");
function addHistory(entry){ state.history.push(entry); save(); }
function addScore(userName, delta, reason, task){
  const u = state.users.find(u=>u.name===userName);
  const id = u ? u.id : state.activeUserId;
  state.score[id] = (state.score[id]||0) + delta;
  addHistory({ when: nowISO(), userId:id, userName: u?u.name:userName, delta, reason, taskTitle: task?.title||"", taskId: task?.id||null });
}
function computeScoreFor(t, whenDate){
  const s = statusForTask(t);
  if(!s.next) return 5;
  const wd=new Date(whenDate), n=new Date(s.next);
  const startDay=new Date(n.getFullYear(), n.getMonth(), n.getDate());
  const doneDay=new Date(wd.getFullYear(), wd.getMonth(), wd.getDate());
  const diffDays=Math.round((doneDay - startDay)/86400000);
  if(diffDays===0) return 10;
  if(diffDays<0)  return 5;
  return 2;
}
function applyScoreDelta(userName, delta, reason, task){
  if(delta===0) return;
  addScore(userName, delta, reason, task);
}
function applyDailyMalus(){
  const today = todayYMD();
  if(state.lastMalusDate===today) return;
  for(const t of state.tasks){
    const s=statusForTask(t);
    if(s.code==="over" && !t.done){
      const name=t.assignee||activeUser().name;
      addScore(name, -5, "malus: pulizia ancora in ritardo", t);
    }
  }
  state.lastMalusDate=today; save();
}
function renderLeader(){
  const rows = state.users.map(u=>({u, pts: state.score[u.id]||0}));
  rows.sort((a,b)=>b.pts-a.pts);
  leaderEl.innerHTML="";
  for(const r of rows){
    const row=document.createElement("div"); row.className="row";
    const img=document.createElement("img"); img.className="avatar"; img.style.width="28px"; img.style.height="28px";
    if(r.u.photo) img.src=r.u.photo; else { img.style.background=r.u.color; }
    const name=document.createElement("strong"); name.textContent=r.u.name;
    const pts=document.createElement("div"); pts.className="pts"; pts.textContent=r.pts+" pt";
    row.appendChild(img); row.appendChild(name); row.appendChild(pts);
    leaderEl.appendChild(row);
  }
}
function renderHistory(){
  const events=[...state.history].sort((a,b)=> new Date(b.when)-new Date(a.when));
  historyList.innerHTML = events.map(ev=>{
    const d=new Date(ev.when);
    const ds=fmtDMYHM(d);
    const sign = ev.delta>=0 ? "+" : "";
    const cls = ev.delta>=0 ? "pos" : "neg";
    return `<div class="event">
<span class="delta ${cls}">${sign}${ev.delta}</span>
<strong>${ev.userName}</strong>
<span>‚Äî ${ev.reason}</span>
${ev.taskTitle? `<em> (${ev.taskTitle})</em>`:""}
<span style="margin-left:auto">${ds}</span>
</div>`;
  }).join("") || "<div class='muted'>Ancora nessun evento.</div>";
}

/* ===== Impostazioni: Utenti ===== */
const usersList=byId("usersList"), activeUserSel=byId("activeUser"), swapToActive=byId("swapToActive");
const uName=byId("u-name"), uColor=byId("u-color"), uPhoto=byId("u-photo"), uAdd=byId("u-add");
function renderColorOptions(sel, currentHex){
  sel.innerHTML = USER_COLORS.map(c=>{
    const selected = c.hex===currentHex ? "selected" : "";
    return `<option value="${c.name}" data-hex="${c.hex}" ${selected}>${c.name}</option>`;
  }).join("");
}
function colorHexFromName(name){
  const f = USER_COLORS.find(c=>c.name===name);
  return f ? f.hex : USER_COLORS[0].hex;
}
function renderUsersList(){
  activeUserSel.innerHTML = state.users.map(u=>`<option value="${u.id}" ${u.id===state.activeUserId?"selected":""}>${u.name}</option>`).join("");
  usersList.innerHTML="";
  state.users.forEach(u=>{
    const wrap=document.createElement("div"); wrap.className="row"; wrap.style.gap="12px";
    const img=document.createElement("img"); img.className="avatar"; img.style.width="32px"; img.style.height="32px"; if(u.photo) img.src=u.photo; else img.style.background=u.color;
    const name=document.createElement("div"); name.textContent=u.name;
    const colorSel=document.createElement("select"); colorSel.style.minWidth="160px";
    renderColorOptions(colorSel, u.color);
    colorSel.addEventListener("change", ()=>{
      const hex = colorHexFromName(colorSel.value);
      u.color = hex; save(); renderUsersList(); renderHeader(); renderLeader(); showToast("üé® Colore utente aggiornato");
    });
    const fileLbl=document.createElement("label"); fileLbl.className="btn"; fileLbl.textContent="Foto"; const file=document.createElement("input"); file.type="file"; file.accept="image/*"; file.style.display="none"; fileLbl.appendChild(file);
    const del=document.createElement("button"); del.className="btn"; del.textContent="Rimuovi";
    wrap.appendChild(img); wrap.appendChild(name); wrap.appendChild(colorSel); wrap.appendChild(fileLbl); wrap.appendChild(del);
    usersList.appendChild(wrap);
    file.addEventListener("change", async e=>{ const f=e.target.files[0]; if(!f) return; const data=await fileToDataURL(f); u.photo=data; save(); renderHeader(); renderUsersList(); renderLeader(); renderHistory(); showToast("üì∑ Foto utente aggiornata"); });
    del.addEventListener("click", ()=>{ if(state.users.length<=1) return alert("Deve esserci almeno un utente."); if(!confirm("Rimuovere utente?")) return; state.users=state.users.filter(x=>x.id!==u.id); if(state.activeUserId===u.id) state.activeUserId=state.users[0].id; save(); renderHeader(); renderUsersList(); renderAssigneeSelects(); renderLeader(); renderHistory(); showToast("Utente rimosso"); });
  });
}
renderColorOptions(uColor, USER_COLORS[2].hex);
uAdd.addEventListener("click", async ()=>{
  const name=uName.value.trim(); if(!name) return;
  const selectedHex = colorHexFromName(uColor.value);
  let photo=null; if(uPhoto.files[0]) photo=await fileToDataURL(uPhoto.files[0]);
  state.users.push({id:crypto.randomUUID(), name, color:selectedHex, photo});
  uName.value=""; uPhoto.value="";
  renderColorOptions(uColor, USER_COLORS[2].hex);
  save(); renderUsersList(); renderAssigneeSelects(); renderLeader(); showToast("üë§ Utente aggiunto");
});
swapToActive.addEventListener("click", ()=>{ setActiveUser(activeUserSel.value); showToast("Utente attivo cambiato"); });

/* ===== Impostazioni: Stanze ===== */
const roomsList=byId("roomsList"), rName=byId("r-name"), rPhoto=byId("r-photo"), rAdd=byId("r-add");
function renderRooms(){
  roomsList.innerHTML="";
  state.settings.rooms.forEach((r,i)=>{
    const item=document.createElement("div"); item.className="row";
    const name=document.createElement("strong"); name.textContent=r.name;
    const img=document.createElement("img"); img.className="avatar"; img.style.width="32px"; img.style.height="32px"; if(r.photo) img.src=r.photo; else img.style.background="#ddd";
    const fileLbl=document.createElement("label"); fileLbl.className="btn"; fileLbl.textContent="Foto"; const file=document.createElement("input"); file.type="file"; file.accept="image/*"; file.style.display="none"; fileLbl.appendChild(file);
    const del=document.createElement("button"); del.className="btn"; del.textContent="Rimuovi";
    item.appendChild(img); item.appendChild(name); item.appendChild(fileLbl); item.appendChild(del);
    roomsList.appendChild(item);
    file.addEventListener("change", async e=>{ const f=e.target.files[0]; if(!f) return; const data=await fileToDataURL(f); state.settings.rooms[i].photo=data; save(); renderRooms(); showToast("üì∑ Foto stanza aggiornata"); });
    del.addEventListener("click", ()=>{ if(!confirm("Rimuovere stanza?")) return; const name=state.settings.rooms[i].name; state.settings.rooms.splice(i,1); state.tasks.forEach(t=>{ if(t.room===name) t.room=""; }); save(); renderRooms(); renderRoomSelect(); renderTasks(); renderCalendar(); showToast("Stanza rimossa"); });
  });
}
rAdd.addEventListener("click", async ()=>{
  const name=rName.value.trim(); if(!name) return;
  let photo=null; if(rPhoto.files[0]) photo=await fileToDataURL(rPhoto.files[0]);
  state.settings.rooms.push({name, photo});
  rName.value=""; rPhoto.value="";
  save(); renderRooms(); renderRoomSelect(); renderTasks(); renderCalendar(); showToast("üè† Stanza aggiunta");
});

/* ===== Aspetto ===== */
const appPalettesEl=byId("appPalettes"), bgTasksFile=byId("bgTasksFile"), bgTasksClear=byId("bgTasksClear");
function renderAppPalettes(){
  appPalettesEl.innerHTML="";
  APP_PALETTES.forEach(p=>{
    const b=document.createElement("button");
    b.className="btn"; b.style.color="#fff"; b.textContent=p.name;
    b.style.background=`linear-gradient(135deg, ${p.brand}, ${p.brand2})`;
    b.addEventListener("click", ()=>{ state.appearance.palette=p; save(); applyPalette(p); renderHeader(); showToast("üé® Palette applicata"); });
    appPalettesEl.appendChild(b);
  });
}
bgTasksFile.addEventListener("change", async (e)=>{ const f=e.target.files[0]; if(!f) return; state.appearance.bgTasks=await fileToDataURL(f); save(); renderHeader(); showToast("üñºÔ∏è Sfondo impostato"); e.target.value=""; });
bgTasksClear.addEventListener("click", ()=>{ state.appearance.bgTasks=null; save(); renderHeader(); showToast("Sfondo rimosso"); });

/* ===== Notifiche & Backup ===== */
byId("enableNotifs").addEventListener("click", requestNotifs);
function requestNotifs(){ if(!("Notification" in window)){ alert("Notifiche non supportate"); return; } if(Notification.permission==="granted"){ showToast("üîî Notifiche gi√† abilitate"); return; } Notification.requestPermission().then(p=>{ if(p==="granted"){ showToast("üîî Notifiche abilitate"); }}); }
const remindAt=byId("remindAt"), resurface=byId("resurface");
remindAt.value = state.settings.remindAt||"09:00"; resurface.checked = !!state.settings.resurfaceUnfinished;
remindAt.addEventListener("change", ()=>{ const v=remindAt.value.trim(); if(/^\d{2}:\d{2}$/.test(v)){ state.settings.remindAt=v; save(); showToast("‚è∞ Ora promemoria aggiornata"); } else { alert("Usa HH:MM"); remindAt.value=state.settings.remindAt||"09:00"; } });
resurface.addEventListener("change", ()=>{ state.settings.resurfaceUnfinished=resurface.checked; save(); showToast(resurface.checked?"üßº Riproponi attivo":"üßº Riproponi disattivato"); });

/* Export/Import parziali */
const exportTasksBtn=byId("exportTasks");
const importTasksInput=byId("importTasks");
const exportMyScoreBtn=byId("exportMyScore");
const importMyScoreInput=byId("importMyScore");
exportTasksBtn.addEventListener("click", ()=>{
  const payload = JSON.stringify({version: state.version, tasks: state.tasks}, null, 2);
  const file=new File([payload],"pulizie-tasks-"+todayYMD()+".json",{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(file); a.download=file.name; a.click(); URL.revokeObjectURL(a.href);
  showToast("‚¨áÔ∏è Esportate solo le pulizie");
});
importTasksInput.addEventListener("change", async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const data=JSON.parse(await f.text());
    if(Array.isArray(data.tasks)){ state.tasks=data.tasks; save(); renderTasks(); renderCalendar(); showToast("‚úÖ Pulizie importate"); }
    else alert("File non valido (manca 'tasks').");
  }catch(err){ alert("Import non riuscito: "+err); }
  e.target.value="";
});
exportMyScoreBtn.addEventListener("click", ()=>{
  const uid=state.activeUserId, name = (state.users.find(u=>u.id===uid)||{}).name || "utente";
  const payload = JSON.stringify({userId: uid, userName: name, score: state.score[uid]||0, history: state.history.filter(h=>h.userId===uid)}, null, 2);
  const file=new File([payload],`classifica-${name.replace(/\s+/g,'_')}.json`,{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(file); a.download=file.name; a.click(); URL.revokeObjectURL(a.href);
  showToast("‚¨áÔ∏è Esportata classifica utente attivo");
});
importMyScoreInput.addEventListener("change", async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const data=JSON.parse(await f.text());
    const uid=state.activeUserId;
    if(typeof data.score==="number"){
      state.score[uid]=data.score;
      if(Array.isArray(data.history)){ state.history = state.history.concat(data.history.map(h=>({...h, userId:uid, userName:(state.users.find(u=>u.id===uid)||{}).name||h.userName, reason:(h.reason||"import")+" (import)"}))); }
      save(); renderLeader(); renderHistory(); showToast("‚úÖ Classifica aggiornata (utente attivo)");
    }else{
      alert("File non valido (manca 'score').");
    }
  }catch(err){ alert("Import non riuscito: "+err); }
  e.target.value="";
});

/* Backup completo */
byId("backup").addEventListener("click", ()=>{ const payload=JSON.stringify(state,null,2); const file=new File([payload],"pulizie-backup-"+todayYMD()+".json",{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(file); a.download=file.name; a.click(); URL.revokeObjectURL(a.href); showToast("üíæ Backup completo creato"); });
const restoreFile = document.getElementById("restoreFile");
restoreFile.addEventListener("change", async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  try{
    state = migrate(JSON.parse(await f.text()));
    save(); boot(); showToast("üß∞ Ripristino completo");
  }catch(err){
    alert("Ripristino non riuscito: " + err);
  }finally{
    e.target.value = "";
  }
});
byId("clearDone").addEventListener("click", ()=>{ state.tasks=state.tasks.filter(t=>!t.done); save(); renderTasks(); renderCalendar(); showToast("üßπ Completate cancellate"); });

/* ===== Bottom Nav (con Calendario) ===== */
const viewTasks=byId("viewTasks"), viewCalendar=byId("viewCalendar"), viewRank=byId("viewRank"), viewSettings=byId("viewSettings");
document.querySelectorAll(".tabbtn").forEach(b=> b.addEventListener("click", ()=>{
  document.querySelectorAll(".tabbtn").forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
  const tab=b.dataset.tab;
  [viewTasks,viewCalendar,viewRank,viewSettings].forEach(v=>v.classList.remove("active"));
  if(tab==="tasks"){ viewTasks.classList.add("active"); byId("appTitle").textContent="Pulizie di Casa"; }
  if(tab==="calendar"){ viewCalendar.classList.add("active"); byId("appTitle").textContent="Calendario Pulizie"; renderCalendar(); }
  if(tab==="rank"){ viewRank.classList.add("active"); byId("appTitle").textContent="Classifica"; renderLeader(); renderHistory(); }
  if(tab==="settings"){ viewSettings.classList.add("active"); byId("appTitle").textContent="Impostazioni"; }
  window.scrollTo({top:0,behavior:"smooth"});
}));

/* ===== Calendario ===== */
const calGrid=byId("calGrid"), calTitle=byId("calTitle"), calDayList=byId("calDayList");
const calPrev=byId("calPrev"), calNext=byId("calNext"), calToday=byId("calToday"), calAdd=byId("calAdd");

let calRef = new Date();
function setCalTo(year, month){ calRef = new Date(year, month, 1); }
function monthLabel(d){ return d.toLocaleDateString('it-IT', { month:'long', year:'numeric' }); }
function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }

function renderCalendar(){
  calTitle.textContent = monthLabel(calRef).replace(/^\w/, c=>c.toUpperCase());
  const y = calRef.getFullYear(), m = calRef.getMonth();
  const firstDow = new Date(y, m, 1).getDay();
  const startOffset = (firstDow+6)%7;
  const totalDays = daysInMonth(y,m);
  const prevMonthDays = daysInMonth(y, m-1);

  const labels = ["Lun","Mar","Mer","Gio","Ven","Sab","Dom"];
  calGrid.innerHTML = labels.map(w=>`<div class="cal-dow">${w}</div>`).join("");

  const cells = [];
  for(let i=0;i<42;i++){
    const dayNum = i - startOffset + 1;
    let d, muted=false;
    if(dayNum < 1){ const n = prevMonthDays + dayNum; d = new Date(y, m-1, n); muted = true; }
    else if(dayNum > totalDays){ const n = dayNum - totalDays; d = new Date(y, m+1, n); muted = true; }
    else { d = new Date(y, m, dayNum); }

    const count = state.tasks.filter(t=>{
      if(t.done) return false;
      return occursOnDay(t, d);
    }).length;

    const cell=document.createElement("div");
    cell.className="cal-cell"+(muted?" muted":"");
    cell.setAttribute("data-date", d.toISOString().slice(0,10));
    cell.innerHTML = `<div class="cal-daynum">${d.getDate()}</div>${count? `<div class="cal-badge">${count}</div>`:""}`;
    cell.addEventListener("click", ()=> renderCalendarDayList(d));
    cells.push(cell);
  }
  cells.forEach(c=>calGrid.appendChild(c));

  const today = new Date();
  if(today.getFullYear()===y && today.getMonth()===m){
    renderCalendarDayList(today);
  }else{
    calDayList.innerHTML = `<div class="cal-empty">Tocca un giorno per vedere i dettagli</div>`;
  }
}
function renderCalendarDayList(d){
  const items = state.tasks.filter(t=> occursOnDay(t, d));
  const title = d.toLocaleDateString('it-IT', { weekday:'long', day:'2-digit', month:'2-digit' });
  if(!items.length){
    calDayList.innerHTML = `<div class="cal-empty"><strong>${title}</strong><br>Nessuna pulizia prevista</div>`;
    return;
  }
  const list = items.sort((a,b)=> (a.priority-b.priority) || (a.title||"").localeCompare(b.title||""))
    .map(t=>{
      const desc = t.notes ? ` ‚Ä¢ ${t.notes}` : "";
      const hasPhotos = t.photo ? ' ‚Ä¢ üì∑1' : '';
      return `<li class="task future" style="list-style:none; margin:8px 0; padding:10px; border-radius:10px; border:1px solid var(--border);">
  <div style="display:flex; gap:8px; align-items:center;">
    <div class="head-main" style="flex:1; min-width:0;">
      <div class="title">${t.title||t.name}</div>
      <div class="notes-line">${desc}${hasPhotos}</div>
    </div>
    <button class="btn" data-edit="${t.id}">Modifica</button>
  </div>
</li>`;
    }).join("");
  calDayList.innerHTML = `<div style="margin-top:12px;"><strong>${title}</strong></div><ul style="padding:0;margin:6px 0 0 0;">${list}</ul>`;
  calDayList.querySelectorAll('button[data-edit]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const t = state.tasks.find(x=>x.id===b.getAttribute('data-edit'));
      if(t) openEditor(t);
    });
  });
}
calPrev.addEventListener("click", ()=>{ setCalTo(calRef.getFullYear(), calRef.getMonth()-1); renderCalendar(); });
calNext.addEventListener("click", ()=>{ setCalTo(calRef.getFullYear(), calRef.getMonth()+1); renderCalendar(); });
calToday.addEventListener("click", ()=>{ const n=new Date(); setCalTo(n.getFullYear(), n.getMonth()); renderCalendar(); });
calAdd.addEventListener("click", ()=> openEditor());

/* ===== Accordion: un solo men√π aperto ===== */
const acc = document.getElementById("settingsAccordion");
if(acc){
  acc.querySelectorAll("details").forEach(d=>{
    d.addEventListener("toggle", ()=>{
      if(d.open){
        acc.querySelectorAll("details").forEach(o=>{ if(o!==d) o.open=false; });
      }
    });
  });
}

/* ===== Adattamento spazio sotto in base alla bottom-nav reale ===== */
function adaptBottomInset(){
  const nav = document.querySelector('.bottom-nav');
  const h = nav ? Math.ceil(nav.getBoundingClientRect().height) : 80;
  const extra = 12;
  document.documentElement.style.setProperty('--bottom-nav-h', (h + extra) + 'px');
}
window.addEventListener('resize', adaptBottomInset);
window.addEventListener('orientationchange', adaptBottomInset);
if(window.visualViewport){
  visualViewport.addEventListener('resize', adaptBottomInset);
}
document.fonts && document.fonts.ready && document.fonts.ready.then(adaptBottomInset);

/* ===== Boot ===== */
function boot(){
  applyPalette(state.appearance.palette||APP_PALETTES[3]);
  renderHeader();
  renderRoomSelect(); renderAssigneeSelects();
  renderUsersList(); renderRooms();
  renderAppPalettes();
  renderRoomFilters(); renderUserFilters(); renderChips();
  renderTasks(); renderLeader(); renderHistory();
  applyDailyMalus();
  const n=new Date(); setCalTo(n.getFullYear(), n.getMonth());

  // calcola lo spazio per evitare il "taglio" in fondo
  adaptBottomInset();

}
boot();
</script>
<script src="main.js?v=1"></script>
</body>
</html>
